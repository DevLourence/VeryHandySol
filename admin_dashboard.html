<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | VeryHandy Solution</title>
    <link rel="icon" href="image/logo/vh_logo.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        purple: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb', // Brand Primary
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        },
                        amber: {
                            400: '#38bdf8', // Brand Secondary
                            500: '#0ea5e9',
                            600: '#0284c7',
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Email System: Powered by EmailJS (Works without custom domain) -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- FullCalendar -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <script src="js/imagekit-upload.js"></script>
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f8fafc;
        }

        .grain-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            opacity: 0.02;
            background-image: url('https://grainy-gradients.vercel.app/noise.svg');
        }

        .blob {
            position: fixed;
            width: 800px;
            height: 800px;
            background: linear-gradient(135deg, rgba(91, 33, 182, 0.05) 0%, rgba(251, 191, 36, 0.03) 100%);
            border-radius: 50%;
            filter: blur(120px);
            z-index: -1;
            animation: move 25s infinite alternate;
        }

        @keyframes move {
            from {
                transform: translate(-10%, -10%) scale(1);
            }

            to {
                transform: translate(10%, 10%) scale(1.1);
            }
        }

        .glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
        }

        /* --- MOBILE IMPROVEMENTS --- */
        @media (max-width: 768px) {
            .tab-content {
                padding: 0 5px;
            }

            .card-premium {
                padding: 1.25rem;
                border-radius: 24px;
            }

            .sidebar-item {
                padding: 0.875rem 1rem !important;
            }

            .notification-dropdown {
                width: calc(100vw - 40px) !important;
                right: -60px !important;
            }

            #growthChart {
                height: 250px !important;
            }
        }

        /* Smooth Sidebar Drawer */
        #adminSidebar {
            will-change: transform;
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* --- ADVANCED MOBILE TABLE TRANSFORM --- */
        @media (max-width: 768px) {

            .card-premium table,
            .card-premium thead,
            .card-premium tbody,
            .card-premium th,
            .card-premium td,
            .card-premium tr {
                display: block;
            }

            .card-premium thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }

            .card-premium tr {
                border-bottom: 1px solid #f1f5f9;
                padding: 1.5rem 0.5rem;
            }

            .card-premium td {
                border: none;
                position: relative;
                padding: 0.5rem 0 0.5rem 40% !important;
                text-align: left !important;
            }

            .card-premium td:before {
                position: absolute;
                top: 0.5rem;
                left: 0;
                width: 35%;
                padding-right: 10px;
                white-space: nowrap;
                font-size: 8px;
                font-weight: 900;
                text-transform: uppercase;
                color: #94a3b8;
                content: attr(data-label);
            }

            /* Specific overrides for tables with many columns */
            .p-10,
            .p-8 {
                padding: 1.25rem !important;
            }

            #calendar {
                height: 400px !important;
            }
        }

        .sidebar-item.active {
            background: #5b21b6 !important;
            color: white !important;
            box-shadow: 0 15px 30px -10px rgba(91, 33, 182, 0.4);
            transform: scale(1.02);
        }

        .sidebar-item:hover:not(.active) {
            background: rgba(255, 255, 255, 0.05);
            transform: scale(1.02);
        }

        .card-premium {
            background: #ffffff;
            border-radius: 32px;
            border: 1px solid rgba(0, 0, 0, 0.03);
            box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.03);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .card-premium:hover {
            transform: translateY(-8px);
            box-shadow: 0 40px 80px -20px rgba(91, 33, 182, 0.1);
            border-color: rgba(91, 33, 182, 0.1);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* --- FORM ELEMENTS --- */
        .input-premium {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .input-premium:focus {
            background: #ffffff;
            border-color: #9333ea;
            box-shadow: 0 0 0 8px rgba(147, 51, 234, 0.05);
            transform: translateY(-2px);
        }

        /* Calendar Styling */
        .fc {
            background: transparent !important;
            border: none !important;
        }

        .fc-toolbar-title {
            font-weight: 900 !important;
            text-transform: uppercase;
            letter-spacing: -0.025em;
        }

        .fc-button-primary {
            background: #0f172a !important;
            border: none !important;
            border-radius: 16px !important;
            padding: 12px 20px !important;
            text-transform: uppercase;
            font-weight: 800;
            font-size: 9px !important;
            letter-spacing: 0.1em;
            transition: all 0.3s ease !important;
        }

        .fc-button-primary:hover {
            background: #5b21b6 !important;
            transform: scale(1.05);
        }

        .fc-daygrid-day:hover {
            background: rgba(91, 33, 182, 0.02);
        }

        /* --- MODERN MODAL STYLES --- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(12px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-container {
            background: #ffffff;
            border: 1px solid rgba(0, 0, 0, 0.05);
            /* Ultra clean border */
            border-radius: 40px;
            /* Softer curves */
            width: 100%;
            max-width: 460px;
            padding: 48px 36px;
            box-shadow:
                0 0 0 10px rgba(255, 255, 255, 0.5),
                /* Inner glow ring */
                0 40px 100px -20px rgba(100, 116, 139, 0.4);
            /* Deep ambient shadow */
            text-align: center;
            transform: scale(0.9) translateY(20px);
            transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        /* Decorative background blur blob */
        .modal-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at center, rgba(99, 102, 241, 0.05) 0%, transparent 70%);
            z-index: 0;
            pointer-events: none;
        }

        .modal-overlay.active .modal-container {
            transform: scale(1) translateY(0);
        }

        .modal-icon-wrapper {
            width: 88px;
            height: 88px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            margin: 0 auto 28px;
            position: relative;
            z-index: 1;
            /* Neumorphic / 3D feel */
            box-shadow:
                inset 0 2px 4px rgba(255, 255, 255, 0.8),
                0 20px 40px -10px rgba(0, 0, 0, 0.15);
        }

        .modal-success .modal-icon-wrapper {
            background: linear-gradient(135deg, #86efac, #22c55e);
            color: #ffffff;
            box-shadow: 0 20px 40px -10px rgba(34, 197, 94, 0.4);
        }

        .modal-danger .modal-icon-wrapper {
            background: linear-gradient(135deg, #fca5a5, #ef4444);
            color: #ffffff;
            box-shadow: 0 20px 40px -10px rgba(239, 68, 68, 0.4);
        }

        .modal-warning .modal-icon-wrapper {
            background: linear-gradient(135deg, #fcd34d, #f59e0b);
            color: #ffffff;
            box-shadow: 0 20px 40px -10px rgba(245, 158, 11, 0.4);
        }

        .modal-info .modal-icon-wrapper {
            background: linear-gradient(135deg, #a5b4fc, #6366f1);
            color: #ffffff;
            box-shadow: 0 20px 40px -10px rgba(99, 102, 241, 0.4);
        }

        .modal-title {
            position: relative;
            z-index: 1;
            font-family: 'Outfit', sans-serif;
            /* Ensuring sleek geometric font */
            font-size: 1.75rem;
            font-weight: 900;
            color: #1e293b;
            margin-bottom: 12px;
            letter-spacing: -0.04em;
            line-height: 1.1;
        }

        .modal-message {
            position: relative;
            z-index: 1;
            font-size: 1rem;
            line-height: 1.7;
            color: #64748b;
            margin-bottom: 40px;
            font-weight: 500;
            max-width: 90%;
            margin-left: auto;
            margin-right: auto;
        }

        .modal-btns {
            position: relative;
            z-index: 1;
            display: flex;
            gap: 16px;
            flex-direction: row;
            /* Back to side-by-side for desktop feel, or keeps sleek */
            align-items: center;
        }

        .modal-btn {
            flex: 1;
            padding: 16px 24px;
            border-radius: 14px;
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border: 1px solid transparent;
        }

        /* EXECUTIVE PRIMARY BUTTON */
        .btn-confirm {
            background: linear-gradient(135deg, #4f46e5 0%, #7e22ce 100%);
            color: white;
            box-shadow: 0 4px 12px -2px rgba(79, 70, 229, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-confirm:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px -4px rgba(79, 70, 229, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .btn-confirm:active {
            transform: translateY(0);
            filter: brightness(0.95);
        }

        /* PREMIUM MODAL BUTTONS */
        .btn-gradient-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 12px -2px rgba(16, 185, 129, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-gradient-success:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px -4px rgba(16, 185, 129, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .btn-gradient-danger {
            background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%);
            color: white;
            box-shadow: 0 4px 12px -2px rgba(239, 68, 68, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-gradient-danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px -4px rgba(239, 68, 68, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .btn-gradient-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 4px 12px -2px rgba(245, 158, 11, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-gradient-warning:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px -4px rgba(245, 158, 11, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .btn-gradient-info {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            box-shadow: 0 4px 12px -2px rgba(99, 102, 241, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-gradient-info:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px -4px rgba(99, 102, 241, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        /* --- NOTIFICATION DROPDOWN --- */
        .notification-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            width: 360px;
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(15, 23, 42, 0.15);
            border: 1px solid rgba(0, 0, 0, 0.05);
            margin-top: 12px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px) scale(0.95);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 10000;
        }

        .notification-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }

        .notification-item {
            padding: 16px;
            border-bottom: 1px solid #f1f5f9;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .notification-item:hover {
            background: #f8fafc;
        }

        .notification-item.unread {
            background: #f5f3ff;
        }

        .notification-item.unread:hover {
            background: #ede9fe;
        }

        #notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 18px;
            height: 18px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 900;
            border: 2px solid white;
        }

        #notification-badge.hidden {
            display: none !important;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900 font-sans antialiased overflow-hidden">
    <div class="grain-overlay"></div>
    <div class="blob" style="top: -200px; left: -200px;"></div>
    <div class="blob"
        style="bottom: -200px; right: -200px; animation-delay: -10s; background: linear-gradient(135deg, rgba(251, 191, 36, 0.05) 0%, rgba(91, 33, 182, 0.03) 100%);">
    </div>

    <div class="flex h-screen overflow-hidden relative">
        <!-- Mobile Sidebar Overlay -->
        <div id="sidebarForwardDrop" class="fixed inset-0 bg-slate-900/50 z-40 hidden backdrop-blur-sm lg:hidden"
            onclick="toggleSidebar()"></div>

        <!-- Sidebar Toggle -->
        <button onclick="toggleSidebar()"
            class="fixed top-5 left-5 z-[70] w-12 h-12 bg-white rounded-2xl shadow-xl lg:hidden text-slate-900 flex items-center justify-center border border-slate-100 hover:bg-slate-50 transition-all">
            <i class="fa-solid fa-bars-staggered"></i>
        </button>

        <aside id="adminSidebar"
            class="absolute lg:relative w-72 bg-[#0f172a] text-white flex flex-col h-full z-50 shadow-2xl transition-transform duration-300 transform -translate-x-full lg:translate-x-0">
            <div class="p-8 pb-10 border-b border-white/5">
                <div class="flex items-center gap-4">
                    <a href="https://veryhandyhomeservice.com"
                        class="w-12 h-12 bg-white rounded-2xl flex items-center justify-center shadow-2xl hover:scale-105 transition-all">
                        <img src="image/logo/logo.svg" class="w-8 h-8 object-contain">
                    </a>
                    <div>
                        <h1 class="text-lg font-black uppercase tracking-tighter leading-none mb-1">VH Admin</h1>
                        <p class="text-[8px] font-black tracking-[0.3em] uppercase opacity-40">System Control</p>
                    </div>
                </div>
            </div>

            <nav class="flex-1 px-4 space-y-6 overflow-y-auto no-scrollbar scroll-smooth py-4">
                <!-- Group: Analytics -->
                <div class="space-y-1">
                    <p class="px-6 text-[8px] font-black text-slate-500 uppercase tracking-[0.3em] mb-2">Main</p>
                    <button id="btn-overview" onclick="switchTab('overview')"
                        class="sidebar-item active w-full flex items-center gap-4 px-6 py-3.5 rounded-2xl transition-all duration-300 group">
                        <div class="w-5 flex justify-center"><i
                                class="fa-solid fa-chart-pie text-sm opacity-50 group-hover:opacity-100 transition-opacity"></i>
                        </div>
                        <span class="text-[10px] font-black uppercase tracking-[0.2em]">Dashboard</span>
                    </button>
                    <button id="btn-schedule" onclick="switchTab('schedule')"
                        class="sidebar-item w-full flex items-center gap-4 px-6 py-3.5 rounded-2xl transition-all duration-300 group">
                        <div class="w-5 flex justify-center"><i
                                class="fa-solid fa-calendar-check text-sm opacity-50 group-hover:opacity-100 transition-opacity"></i>
                        </div>
                        <span class="text-[10px] font-black uppercase tracking-[0.2em]">Calendar</span>
                    </button>
                </div>

                <!-- Group: Operations -->
                <div class="space-y-1">
                    <p class="px-6 text-[8px] font-black text-slate-500 uppercase tracking-[0.3em] mb-2">Operations</p>
                    <button id="btn-bookings" onclick="switchTab('bookings')"
                        class="sidebar-item w-full flex items-center gap-4 px-6 py-3.5 rounded-2xl transition-all duration-300 group">
                        <div class="w-5 flex justify-center"><i
                                class="fa-solid fa-car-wrench text-sm opacity-50 group-hover:opacity-100 transition-opacity"></i>
                        </div>
                        <span class="text-[10px] font-black uppercase tracking-[0.2em]">Bookings</span>
                    </button>
                    <button id="btn-accounts" onclick="switchTab('accounts')"
                        class="sidebar-item w-full flex items-center gap-4 px-6 py-3.5 rounded-2xl transition-all duration-300 group">
                        <div class="w-5 flex justify-center"><i
                                class="fa-solid fa-user-group text-sm opacity-50 group-hover:opacity-100 transition-opacity"></i>
                        </div>
                        <span class="text-[10px] font-black uppercase tracking-[0.2em]">Customers</span>
                    </button>
                    <button id="btn-reviews" onclick="switchTab('reviews')"
                        class="sidebar-item w-full flex items-center gap-4 px-6 py-3.5 rounded-2xl transition-all duration-300 group">
                        <div class="w-5 flex justify-center"><i
                                class="fa-solid fa-comment-dots text-sm opacity-50 group-hover:opacity-100 transition-opacity"></i>
                        </div>
                        <span class="text-[10px] font-black uppercase tracking-[0.2em]">Feedback</span>
                    </button>
                </div>

                <!-- Group: Infrastructure -->
                <div class="space-y-1">
                    <p class="px-6 text-[8px] font-black text-slate-500 uppercase tracking-[0.3em] mb-2">Management</p>
                    <button id="btn-branches" onclick="switchTab('branches')"
                        class="sidebar-item w-full flex items-center gap-4 px-6 py-3.5 rounded-2xl transition-all duration-300 group">
                        <div class="w-5 flex justify-center"><i
                                class="fa-solid fa-shop text-sm opacity-50 group-hover:opacity-100 transition-opacity"></i>
                        </div>
                        <span class="text-[10px] font-black uppercase tracking-[0.2em]">Branches</span>
                    </button>
                    <button id="btn-services" onclick="switchTab('services')"
                        class="sidebar-item w-full flex items-center gap-4 px-6 py-3.5 rounded-2xl transition-all duration-300 group">
                        <div class="w-5 flex justify-center"><i
                                class="fa-solid fa-screwdriver-wrench text-sm opacity-50 group-hover:opacity-100 transition-opacity"></i>
                        </div>
                        <span class="text-[10px] font-black uppercase tracking-[0.2em]">Services</span>
                    </button>
                </div>

                <!-- Group: Assets -->
                <div class="space-y-1">
                    <p class="px-6 text-[8px] font-black text-slate-500 uppercase tracking-[0.3em] mb-2">Assets</p>
                    <button id="btn-portfolio" onclick="switchTab('portfolio')"
                        class="sidebar-item w-full flex items-center gap-4 px-6 py-3.5 rounded-2xl transition-all duration-300 group">
                        <div class="w-5 flex justify-center"><i
                                class="fa-solid fa-briefcase text-sm opacity-50 group-hover:opacity-100 transition-opacity"></i>
                        </div>
                        <span class="text-[10px] font-black uppercase tracking-[0.2em]">Portfolio</span>
                    </button>
                    <button id="btn-media" onclick="switchTab('media')"
                        class="sidebar-item w-full flex items-center gap-4 px-6 py-3.5 rounded-2xl transition-all duration-300 group">
                        <div class="w-5 flex justify-center"><i
                                class="fa-solid fa-images text-sm opacity-50 group-hover:opacity-100 transition-opacity"></i>
                        </div>
                        <span class="text-[10px] font-black uppercase tracking-[0.2em]">Media Lib</span>
                    </button>
                </div>

                <!-- Group: Maintenance -->
                <div class="space-y-1">
                    <p class="px-6 text-[8px] font-black text-slate-500 uppercase tracking-[0.3em] mb-2">System</p>
                    <button id="btn-logs" onclick="switchTab('logs')"
                        class="sidebar-item w-full flex items-center gap-4 px-6 py-3.5 rounded-2xl transition-all duration-300 group">
                        <div class="w-5 flex justify-center"><i
                                class="fa-solid fa-scroll text-sm opacity-50 group-hover:opacity-100 transition-opacity"></i>
                        </div>
                        <span class="text-[10px] font-black uppercase tracking-[0.2em]">Operations Audit</span>
                    </button>
                </div>
            </nav>

            <div class="p-6 mt-auto">
                <button onclick="handleLogout()"
                    class="w-full flex items-center justify-center gap-3 px-6 py-4 rounded-2xl text-rose-400 hover:bg-rose-500 hover:text-white transition-all font-black uppercase text-[10px] tracking-[0.2em] border border-rose-500/20">
                    <i class="fa-solid fa-power-off"></i>
                    <span>System Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-5 md:p-12 relative no-scrollbar">
            <!-- Header -->
            <header
                class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-10 md:mb-16 relative z-[60] pt-16 md:pt-0">
                <div class="w-full md:w-auto px-1 md:px-0">
                    <h2 id="section-title"
                        class="text-2xl md:text-4xl font-black text-slate-900 uppercase tracking-tighter leading-none mb-2">
                        Service Hub</h2>
                    <p
                        class="text-[9px] md:text-[10px] font-black tracking-[0.2em] md:tracking-[0.4em] uppercase text-purple-600">
                        VeryHandy Solution Inc. Management</p>
                </div>
                <div class="flex-1 px-12 hidden md:block">
                    <div class="relative max-w-md mx-auto">
                        <i
                            class="fa-solid fa-search absolute left-5 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
                        <input type="text" onkeyup="globalSearch(this.value)" placeholder="SEARCH DATABASE..."
                            class="w-full pl-12 pr-5 py-4 bg-white/50 border border-slate-200 rounded-2xl text-xs font-bold tracking-widest outline-none focus:border-purple-500 focus:ring-4 focus:ring-purple-500/10 transition-all shadow-sm">
                    </div>
                </div>
                <div class="flex items-center gap-4 md:gap-8 ml-auto md:ml-0">
                    <div class="relative">
                        <button onclick="toggleNotifications()"
                            class="w-10 h-10 md:w-12 md:h-12 rounded-2xl bg-white border border-slate-100 flex items-center justify-center text-slate-400 hover:text-purple-600 hover:border-purple-600 transition-all shadow-sm">
                            <i class="fa-solid fa-bell"></i>
                            <span id="notification-badge" class="hidden">0</span>
                        </button>
                        <div id="notification-dropdown" class="notification-dropdown overflow-hidden">
                            <div class="p-5 border-b border-slate-50 flex justify-between items-center bg-slate-50/50">
                                <h3 class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-900">System
                                    Alerts</h3>
                                <button onclick="markAllAsRead()"
                                    class="text-[8px] font-black uppercase tracking-widest text-purple-600 hover:underline">Clear
                                    All</button>
                            </div>
                            <div id="notification-list" class="max-height-[400px] overflow-y-auto no-scrollbar">
                                <!-- Notifications Injected Here -->
                                <div class="p-8 text-center text-slate-400">
                                    <i class="fa-solid fa-bell-slash text-2xl mb-3 opacity-20"></i>
                                    <p class="text-[9px] font-black uppercase tracking-widest">No New Alerts</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="h-8 md:h-10 w-px bg-slate-200"></div>
                    <div class="flex items-center gap-3 md:gap-4">
                        <div class="text-right hidden sm:block">
                            <p id="admin-name" class="font-black text-slate-900 text-xs uppercase tracking-widest">Admin
                            </p>
                            <p class="text-[10px] font-bold text-emerald-500 uppercase tracking-widest">System Active
                            </p>
                        </div>
                        <div
                            class="w-10 h-10 md:w-12 md:h-12 rounded-2xl bg-purple-600 flex items-center justify-center text-white shadow-xl shadow-purple-500/20">
                            <i class="fa-solid fa-toolbox"></i>
                        </div>
                    </div>
                </div>
            </header>

            </header>

            <!-- DASHBOARD OVERVIEW (NEW) -->
            <section id="overview-section" class="tab-content relative z-10">
                <!-- KPI Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 mb-12">
                    <div
                        class="card-premium p-6 flex flex-col justify-between h-40 group hover:scale-[1.02] transition-transform">
                        <div class="flex justify-between items-start">
                            <div class="min-w-0">
                                <p
                                    class="text-[8px] md:text-[10px] font-black text-slate-400 uppercase tracking-widest truncate">
                                    Total Clients
                                </p>
                                <h3 id="stat-total-clients" class="text-xl md:text-3xl font-black text-slate-900 mt-1">-
                                </h3>
                            </div>
                            <div
                                class="w-8 h-8 md:w-10 md:h-10 rounded-xl bg-purple-50 text-purple-600 flex items-center justify-center text-sm md:text-lg shrink-0">
                                <i class="fa-solid fa-users"></i>
                            </div>
                        </div>
                        <div class="w-full bg-slate-100 h-1 mt-auto rounded-full overflow-hidden">
                            <div class="h-full bg-purple-500 w-3/4"></div>
                        </div>
                    </div>
                    <div
                        class="card-premium p-6 flex flex-col justify-between h-40 group hover:scale-[1.02] transition-transform">
                        <div class="flex justify-between items-start">
                            <div class="min-w-0">
                                <p
                                    class="text-[8px] md:text-[10px] font-black text-slate-400 uppercase tracking-widest truncate">
                                    Active Jobs
                                </p>
                                <h3 id="stat-active-jobs" class="text-xl md:text-3xl font-black text-slate-900 mt-1">-
                                </h3>
                            </div>
                            <div
                                class="w-8 h-8 md:w-10 md:h-10 rounded-xl bg-amber-50 text-amber-500 flex items-center justify-center text-sm md:text-lg shrink-0">
                                <i class="fa-solid fa-bolt"></i>
                            </div>
                        </div>
                        <div class="w-full bg-slate-100 h-1 mt-auto rounded-full overflow-hidden">
                            <div class="h-full bg-amber-500 w-1/2 animate-pulse"></div>
                        </div>
                    </div>
                    <div
                        class="card-premium p-6 flex flex-col justify-between h-40 group hover:scale-[1.02] transition-transform">
                        <div class="flex justify-between items-start">
                            <div class="min-w-0">
                                <p
                                    class="text-[8px] md:text-[10px] font-black text-slate-400 uppercase tracking-widest truncate">
                                    Pending
                                    Reviews</p>
                                <h3 id="stat-pending-reviews"
                                    class="text-xl md:text-3xl font-black text-slate-900 mt-1">-</h3>
                            </div>
                            <div
                                class="w-8 h-8 md:w-10 md:h-10 rounded-xl bg-rose-50 text-rose-500 flex items-center justify-center text-sm md:text-lg shrink-0">
                                <i class="fa-solid fa-star-half-stroke"></i>
                            </div>
                        </div>
                        <div class="w-full bg-slate-100 h-1 mt-auto rounded-full overflow-hidden">
                            <div class="h-full bg-rose-500 w-1/4"></div>
                        </div>
                    </div>
                    <div
                        class="card-premium p-6 flex flex-col justify-between h-40 group hover:scale-[1.02] transition-transform">
                        <div class="flex justify-between items-start">
                            <div class="min-w-0">
                                <p
                                    class="text-[8px] md:text-[10px] font-black text-slate-400 uppercase tracking-widest truncate">
                                    Growth Rate
                                </p>
                                <h3 class="text-xl md:text-3xl font-black text-emerald-500 mt-1">+12%</h3>
                            </div>
                            <div
                                class="w-8 h-8 md:w-10 md:h-10 rounded-xl bg-emerald-50 text-emerald-500 flex items-center justify-center text-sm md:text-lg shrink-0">
                                <i class="fa-solid fa-chart-line"></i>
                            </div>
                        </div>
                        <p class="text-[9px] text-slate-400 font-bold uppercase tracking-wider mt-2">vs Last Month</p>
                    </div>
                </div>

                <!-- Main Analytics Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
                    <!-- Main Chart -->
                    <div class="lg:col-span-2 card-premium p-8">
                        <div class="flex justify-between items-end mb-8">
                            <div>
                                <h3 class="font-black text-slate-900 tracking-[0.2em] uppercase text-xs">Booking Volume
                                </h3>
                                <span class="text-[9px] font-black text-slate-300 uppercase tracking-widest">6-Month
                                    Trajectory</span>
                            </div>
                        </div>
                        <div class="h-80 w-full relative">
                            <canvas id="growthChart"></canvas>
                        </div>
                    </div>

                    <!-- Pulse Feed (Sidebar) -->
                    <div class="card-premium p-6 md:p-8 flex flex-col h-[350px] md:h-[500px]">
                        <div class="flex items-center justify-between mb-8">
                            <div>
                                <h3 class="font-black text-slate-900 tracking-[0.2em] uppercase text-xs">Live Pulse</h3>
                                <div class="flex items-center gap-1.5 mt-1">
                                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                                    <span class="text-[9px] font-black text-slate-300 uppercase tracking-widest">System
                                        Activity</span>
                                </div>
                            </div>
                            <button onclick="fetchAnalytics()"
                                class="text-slate-400 hover:text-purple-600 transition-colors">
                                <i class="fa-solid fa-rotate-right text-xs"></i>
                            </button>
                        </div>
                        <div id="pulse-feed-container" class="flex-1 overflow-y-auto no-scrollbar space-y-6">
                            <!-- Injected by JS -->
                            <div class="h-full flex flex-col items-center justify-center opacity-20 gap-3 grayscale">
                                <i class="fa-solid fa-satellite-dish text-4xl"></i>
                                <p class="text-[10px] font-black uppercase tracking-widest">Scanning logs...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="accounts-section" class="tab-content hidden relative z-10">
                <div class="card-premium overflow-hidden">
                    <div class="p-10 border-b border-slate-50 flex justify-between items-center bg-slate-50/20">
                        <div>
                            <h3 class="font-black text-slate-900 tracking-[0.2em] uppercase text-xs">Customer Directory
                            </h3>
                            <span class="text-[9px] font-black text-slate-300 uppercase tracking-widest">Active Client
                                Database</span>
                        </div>
                        <button onclick="exportToCSV('clients')"
                            class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl text-[9px] font-black uppercase tracking-widest transition-colors flex items-center gap-2">
                            <i class="fa-solid fa-download"></i> Export CSV
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left min-w-[800px]">
                            <thead
                                class="bg-slate-50/50 text-[9px] font-black uppercase tracking-[0.2em] text-slate-400">
                                <tr>
                                    <th class="p-8 text-slate-500">Customer Identity</th>
                                    <th class="p-8 text-slate-500">Contact Information</th>
                                    <th class="p-8 text-slate-500">Account Status</th>
                                    <th class="p-8 text-slate-500">Registered Date</th>
                                    <th class="p-8 text-right text-slate-500">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="client-table-body" class="divide-y divide-slate-50/50"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="schedule-section" class="tab-content hidden relative z-10">
                <div class="card-premium p-10 min-h-[700px]">
                    <div class="flex items-center gap-3 mb-10">
                        <div class="w-10 h-10 rounded-xl bg-purple-50 text-purple-600 flex items-center justify-center">
                            <i class="fa-solid fa-calendar-check text-lg"></i>
                        </div>
                        <h3 class="font-black text-slate-900 tracking-[0.2em] uppercase text-xs">Service Schedule Map
                        </h3>
                    </div>
                    <div id="calendar"></div>
                </div>
            </section>

            <section id="bookings-section" class="tab-content hidden relative z-10">
                <div class="card-premium overflow-hidden">
                    <div class="p-10 border-b border-slate-50 flex justify-between items-center bg-slate-50/20">
                        <div>
                            <h3 class="font-black text-slate-900 tracking-[0.2em] uppercase text-xs">Active Service
                                Orders</h3>
                            <span class="text-[9px] font-black text-slate-300 uppercase tracking-widest">Live Booking
                                Stream</span>
                        </div>
                        <button onclick="exportToCSV('bookings')"
                            class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl text-[9px] font-black uppercase tracking-widest transition-colors flex items-center gap-2">
                            <i class="fa-solid fa-download"></i> Export CSV
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left min-w-[800px]">
                            <thead
                                class="bg-slate-50/50 text-[9px] font-black uppercase tracking-[0.2em] text-slate-400">
                                <tr>
                                    <th class="p-8 text-slate-500">Customer & Service</th>
                                    <th class="p-8 text-slate-500">Location & Timing</th>
                                    <th class="p-8 text-slate-500">Media Assets</th>
                                    <th class="p-8 text-slate-500">Order Status</th>
                                    <th class="p-8 text-right text-slate-500">Manage</th>
                                </tr>
                            </thead>
                            <tbody id="booking-table-body" class="divide-y divide-slate-50/50"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="reviews-section" class="tab-content hidden relative z-10">
                <div class="card-premium overflow-hidden">
                    <div class="p-10 border-b border-slate-50 flex justify-between items-center bg-slate-50/20">
                        <h3 class="font-black text-slate-900 tracking-[0.2em] uppercase text-xs">Customer Experience Hub
                        </h3>
                        <span class="text-[9px] font-black text-slate-300 uppercase tracking-widest">Global Feedback
                            stream</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left min-w-[800px]">
                            <thead
                                class="bg-slate-50/50 text-[9px] font-black uppercase tracking-[0.2em] text-slate-400">
                                <tr>
                                    <th class="p-8 text-slate-500">Customer</th>
                                    <th class="p-8 text-slate-500">Service Review</th>
                                    <th class="p-8 text-center text-slate-500">Photos</th>
                                    <th class="p-8 text-center text-slate-500 w-32">Status</th>
                                    <th class="p-8 text-right text-slate-500">Operation</th>
                                </tr>
                            </thead>
                            <tbody id="review-table-body" class="divide-y divide-slate-50/50"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="branches-section" class="tab-content hidden relative z-10">
                <!-- Add Branch Form -->
                <div class="card-premium p-10 mb-10">
                    <div class="flex items-center gap-3 mb-8">
                        <div class="w-10 h-10 rounded-xl bg-purple-50 text-purple-600 flex items-center justify-center">
                            <i class="fa-solid fa-shop text-lg"></i>
                        </div>
                        <h2 class="text-xs font-black text-slate-900 uppercase tracking-[0.2em]">Register New Branch
                            Location</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        <input id="branch-name" placeholder="BRANCH NAME"
                            class="w-full p-5 input-premium rounded-2xl outline-none font-bold text-sm tracking-tight">
                        <input id="branch-address" placeholder="PHYSICAL ADDRESS"
                            class="w-full p-5 input-premium rounded-2xl outline-none font-bold text-sm tracking-tight">
                        <button onclick="addBranch()"
                            class="bg-slate-900 hover:bg-purple-600 text-white font-black py-5 px-8 rounded-2xl shadow-2xl transition-all uppercase text-[10px] tracking-[0.2em] flex items-center justify-center gap-2">
                            <i class="fa-solid fa-plus-circle"></i> Save Branch
                        </button>
                    </div>
                </div>
                <div class="card-premium overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50/50 text-[9px] font-black uppercase tracking-[0.2em] text-slate-400">
                            <tr>
                                <th class="p-8">Branch Name</th>
                                <th class="p-8">Service Area</th>
                                <th class="p-8 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="branch-table-body" class="divide-y divide-slate-50/50"></tbody>
                    </table>
                </div>
            </section>

            <section id="services-section" class="tab-content hidden relative z-10">
                <div class="card-premium p-10 mb-10">
                    <div class="flex items-center gap-3 mb-8">
                        <div class="w-10 h-10 rounded-xl bg-amber-50 text-amber-600 flex items-center justify-center">
                            <i class="fa-solid fa-screwdriver-wrench text-lg"></i>
                        </div>
                        <h2 class="text-xs font-black text-slate-900 uppercase tracking-[0.2em]">Add Maintenance Service
                            Offering</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                        <input id="service-name" placeholder="SERVICE NAME"
                            class="w-full p-5 input-premium rounded-2xl outline-none font-bold text-sm tracking-tight">
                        <input id="service-desc" placeholder="SERVICE DESCRIPTION"
                            class="w-full p-5 input-premium rounded-2xl outline-none font-bold text-sm tracking-tight">
                        <input id="service-fee" placeholder="SERVICE FEE ($)"
                            class="w-full p-5 input-premium rounded-2xl outline-none font-bold text-sm tracking-tight">
                        <button onclick="addService()"
                            class="bg-purple-600 hover:bg-slate-900 text-white font-black py-5 px-8 rounded-2xl shadow-2xl transition-all uppercase text-[10px] tracking-[0.2em] flex items-center justify-center gap-2">
                            <i class="fa-solid fa-plus-circle"></i> Save Service
                        </button>
                    </div>
                </div>
                <div class="card-premium overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50/50 text-[9px] font-black uppercase tracking-[0.2em] text-slate-400">
                            <tr>
                                <th class="p-8">Service Type</th>
                                <th class="p-8">Description</th>
                                <th class="p-8">Standard Fee</th>
                                <th class="p-8 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="service-table-body" class="divide-y divide-slate-50/50"></tbody>
                    </table>
                </div>
            </section>

            <section id="portfolio-section" class="tab-content hidden relative z-10">
                <div class="card-premium p-10 mb-10">
                    <div class="flex items-center gap-3 mb-8">
                        <div class="w-10 h-10 rounded-xl bg-indigo-50 text-indigo-600 flex items-center justify-center">
                            <i class="fa-solid fa-briefcase text-lg"></i>
                        </div>
                        <h2 class="text-xs font-black text-slate-900 uppercase tracking-[0.2em]">Add Portfolio Project
                        </h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                        <div class="col-span-1 lg:col-span-2">
                            <input id="portfolio-title" placeholder="PROJECT TITLE (e.g. Tesla Model 3 Restoration)"
                                class="w-full p-5 input-premium rounded-2xl outline-none font-bold text-sm tracking-tight mb-4">
                            <input id="portfolio-desc" placeholder="DESCRIPTION"
                                class="w-full p-5 input-premium rounded-2xl outline-none font-bold text-sm tracking-tight">
                        </div>
                        <div class="col-span-1 lg:col-span-1">
                            <div class="relative group h-full">
                                <input type="file" id="portfolio-image" class="hidden" accept="image/*"
                                    onchange="previewPortfolioImage(this)">
                                <label for="portfolio-image"
                                    class="flex flex-col items-center justify-center h-full border-2 border-dashed border-slate-200 rounded-2xl cursor-pointer hover:border-indigo-400 hover:bg-indigo-50/30 transition-all p-4">
                                    <i
                                        class="fa-solid fa-cloud-arrow-up text-slate-300 group-hover:text-indigo-400 text-2xl mb-2"></i>
                                    <span
                                        class="text-[10px] font-black text-slate-400 uppercase tracking-widest text-center"
                                        id="portfolio-image-label">Upload Image Link or File</span>
                                </label>
                                <input id="portfolio-image-url" type="hidden">
                            </div>
                        </div>
                        <button onclick="addPortfolioItem()"
                            class="bg-indigo-600 hover:bg-slate-900 text-white font-black py-5 px-8 rounded-2xl shadow-2xl transition-all uppercase text-[10px] tracking-[0.2em] flex items-center justify-center gap-2 h-fit self-end">
                            <i class="fa-solid fa-plus-circle"></i> Save Project
                        </button>
                    </div>
                    <div id="portfolio-preview-container"
                        class="hidden mt-6 overflow-hidden rounded-2xl border border-slate-100 bg-slate-50 p-4">
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-[0.2em] mb-3">Live Preview:
                        </p>
                        <img id="portfolio-preview-img" class="h-32 rounded-xl object-cover shadow-lg">
                    </div>
                </div>
                <div class="card-premium overflow-hidden">
                    <div class="p-10 border-b border-slate-50 flex justify-between items-center bg-slate-50/20">
                        <h3 class="font-black text-slate-900 tracking-[0.2em] uppercase text-xs">Project Archive</h3>
                        <span class="text-[9px] font-black text-slate-300 uppercase tracking-widest">Mastery
                            Showcase</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead
                                class="bg-slate-50/50 text-[9px] font-black uppercase tracking-[0.2em] text-slate-400">
                                <tr>
                                    <th class="p-8">Visual</th>
                                    <th class="p-8">Project Details</th>
                                    <th class="p-8">Order</th>
                                    <th class="p-8 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="portfolio-table-body" class="divide-y divide-slate-50/50"></tbody>
                        </table>
                    </div>
                </div>
            </section>
            <section id="logs-section" class="tab-content hidden relative z-10">
                <div class="card-premium overflow-hidden">
                    <div class="p-10 border-b border-slate-50 flex justify-between items-center bg-slate-50/20">
                        <h3 class="font-black text-slate-900 tracking-[0.2em] uppercase text-xs">System Audit Trail</h3>
                        <span class="text-[9px] font-black text-slate-300 uppercase tracking-widest">Secure
                            Administrative Logs</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left min-w-[800px]">
                            <thead
                                class="bg-slate-50/50 text-[9px] font-black uppercase tracking-[0.2em] text-slate-400">
                                <tr>
                                    <th class="p-8 text-slate-500">Timestamp</th>
                                    <th class="p-8 text-slate-500">Admin User</th>
                                    <th class="p-8 text-slate-500">Action Type</th>
                                    <th class="p-8 text-slate-500">Details</th>
                                </tr>
                            </thead>
                            <tbody id="logs-table-body" class="divide-y divide-slate-50/50"></tbody>
                        </table>
                    </div>
                </div>
            </section>
            <section id="media-section" class="tab-content hidden relative z-10">
                <div class="mb-12 flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                    <div>
                        <h2 class="text-4xl font-black text-slate-900 uppercase tracking-tighter leading-none mb-2">
                            Service Media Archive</h2>
                        <div class="flex items-center gap-4 mt-2">
                            <p class="text-[10px] font-black tracking-[0.4em] uppercase text-purple-600">Job Photos &
                                Project Records</p>
                            <div id="cleanup-alert"
                                class="hidden flex items-center gap-2 bg-rose-50 text-rose-500 px-3 py-1 rounded-full animate-pulse border border-rose-100">
                                <i class="fa-solid fa-broom text-[8px]"></i>
                                <span id="cleanup-count" class="text-[8px] font-black uppercase tracking-widest">0
                                    candidates</span>
                                <button onclick="purgeOldMedia()"
                                    class="text-[8px] font-black uppercase tracking-widest underline underline-offset-2 ml-1">Purge
                                    Now</button>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div
                            class="bg-white/50 backdrop-blur-md px-6 py-3 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-4">
                            <i class="fa-solid fa-cloud-arrow-up text-purple-500 text-sm"></i>
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">ImageKit Sync
                                Active</span>
                        </div>
                    </div>
                </div>

                <!-- Media Stats Summary -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
                    <div class="card-premium p-8 flex items-center gap-6">
                        <div
                            class="w-14 h-14 rounded-2xl bg-purple-50 text-purple-600 flex items-center justify-center shrink-0">
                            <i class="fa-solid fa-photo-film text-xl"></i>
                        </div>
                        <div>
                            <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Total Library
                                Assets</p>
                            <h4 id="media-count" class="text-2xl font-black text-slate-900 leading-none">Scanning
                                assets...</h4>
                        </div>
                    </div>
                    <div class="card-premium p-8 col-span-2">
                        <div class="flex justify-between items-end mb-4">
                            <div>
                                <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Vault
                                    Storage Capacity</p>
                                <h4 id="storage-percent" class="text-lg font-black text-slate-900 leading-none">
                                    Calculating...</h4>
                            </div>
                            <span class="text-[10px] font-bold text-slate-300 uppercase tracking-widest">1GB Cloud
                                Limit</span>
                        </div>
                        <div class="h-2 w-full bg-slate-100 rounded-full overflow-hidden">
                            <div id="storage-bar" class="h-full bg-purple-600 transition-all duration-1000"
                                style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div id="media-vault-container"
                    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8 pb-20">
                    <!-- Media assets will follow -->
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <div id="event-modal" class="modal-overlay">
        <div class="modal-container max-w-lg">
            <div class="flex justify-between items-center mb-8">
                <div id="modal-status-badge"
                    class="px-4 py-2 rounded-full text-[9px] font-black uppercase tracking-[0.2em]"></div>
                <button onclick="closeEventModal()"
                    class="w-12 h-12 rounded-2xl bg-slate-50 text-slate-400 hover:bg-rose-50 hover:text-rose-500 transition-all flex items-center justify-center border border-slate-100">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="text-left space-y-8">
                <div>
                    <h3 id="modal-project"
                        class="text-4xl font-black text-slate-900 uppercase tracking-tighter leading-none mb-3"></h3>
                    <p id="modal-client" class="text-[10px] font-black text-purple-600 uppercase tracking-[0.3em]"></p>
                </div>
                <div class="grid grid-cols-2 gap-6">
                    <div class="p-6 bg-slate-50/50 rounded-3xl border border-slate-100">
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-2">Appointment Time
                        </p>
                        <p id="modal-time" class="text-xs font-bold text-slate-900"></p>
                    </div>
                    <div class="p-6 bg-slate-50/50 rounded-3xl border border-slate-100">
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-2">Service Branch
                        </p>
                        <p id="modal-branch" class="text-xs font-bold text-slate-900"></p>
                    </div>
                </div>
            </div>
            <button onclick="closeEventModal()"
                class="w-full mt-10 bg-slate-900 text-white font-black py-5 rounded-2xl uppercase text-[10px] tracking-[0.2em] shadow-2xl hover:bg-purple-600 transition-all">
                Close Record Details
            </button>
        </div>
    </div>

    <div id="add-portfolio-modal" class="modal-overlay">
        <div class="modal-container max-w-xl">
            <div class="flex justify-between items-center mb-10">
                <h3 class="text-2xl font-black text-slate-900 uppercase tracking-tight">Add Showcase Project</h3>
                <button onclick="document.getElementById('add-portfolio-modal').classList.remove('active')"
                    class="w-12 h-12 rounded-2xl bg-slate-50 text-slate-400 hover:bg-rose-50 hover:text-rose-500 transition-all flex items-center justify-center">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <form onsubmit="savePortfolio(event)" class="space-y-6 text-left">
                <div class="grid grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label
                            class="block text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Service
                            Performed</label>
                        <input type="text" id="port-title" required
                            class="w-full p-5 input-premium rounded-2xl outline-none font-bold text-sm">
                    </div>
                    <div class="space-y-2">
                        <label
                            class="block text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Vehicle
                            Model</label>
                        <input type="text" id="port-type"
                            class="w-full p-5 input-premium rounded-2xl outline-none font-bold text-sm">
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="block text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Work
                        Highlights</label>
                    <textarea id="port-desc" required rows="3"
                        class="w-full p-5 input-premium rounded-2xl outline-none font-bold text-sm"></textarea>
                </div>
                <div class="space-y-2">
                    <label class="block text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Showcase
                        Image URL</label>
                    <input type="url" id="port-url" required
                        class="w-full p-5 input-premium rounded-2xl outline-none font-bold text-sm">
                </div>
                <div class="flex gap-4 pt-4">
                    <button type="button"
                        onclick="document.getElementById('add-portfolio-modal').classList.remove('active')"
                        class="flex-1 bg-slate-100 text-slate-400 font-black py-5 rounded-2xl uppercase tracking-widest text-[10px]">Cancel</button>
                    <button type="submit" id="btn-port-save"
                        class="flex-[2] bg-purple-600 text-white font-black py-5 rounded-2xl shadow-2xl hover:bg-slate-900 transition-all uppercase tracking-[0.2em] text-[10px]">Publish
                        to Portfolio</button>
                </div>
            </form>
        </div>
    </div>

    <div id="lightbox-modal" class="modal-overlay">
        <div class="absolute top-10 right-10 z-[100]">
            <button onclick="closeLightbox()"
                class="w-16 h-16 rounded-2xl bg-white/10 text-white hover:bg-rose-500 transition-all flex items-center justify-center backdrop-blur-2xl border border-white/20">
                <i class="fa-solid fa-xmark text-2xl"></i>
            </button>
        </div>
        <div id="lightbox-content" class="max-w-[90vw] max-h-[85vh] flex items-center justify-center relative z-10">
        </div>
    </div>

    <!-- UI Modal -->
    <div id="ui-modal" class="modal-overlay">
        <div class="modal-container">
            <div id="modal-icon-container" class="modal-icon-wrapper"></div>
            <h3 id="ui-modal-title" class="modal-title"></h3>
            <p id="ui-modal-msg" class="modal-message"></p>
            <div class="modal-btns">
                <button id="modal-cancel" class="modal-btn btn-cancel">Cancel</button>
                <button id="modal-confirm" class="modal-btn btn-confirm bg-slate-900">Confirm Action</button>
            </div>
        </div>
    </div>

    <script>
        // --- SUPABASE CONFIG ---
        const SUPABASE_URL = 'https://imvgiqlhpaeotevsffaf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltdmdpcWxocGFlb3RldnNmZmFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0Nzg4MjMsImV4cCI6MjA4NTA1NDgyM30.X0n2IadDlJvgWM9gsV9lK0o2qPN1qnI06hZRD6PL3X8';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- EMAILJS CONFIG (Update these with your keys) ---
        const EMAILJS_PUBLIC_KEY = 'KrQKBIJbfctFaiUJm';
        const EMAILJS_SERVICE_ID = 'service_e823gnp';
        const EMAILJS_TEMPLATE_STATUS_UPDATE = 'template_tegjopc';

        emailjs.init(EMAILJS_PUBLIC_KEY);

        // --- VISUAL ANALYTICS SYSTEM ---
        let growthChartInstance = null;

        async function fetchAnalytics() {
            try {
                // 1. KPI: Total Clients
                const { count: clientCount } = await _supabase.from('profiles').select('*', { count: 'exact', head: true }).eq('role', 'client');
                document.getElementById('stat-total-clients').innerText = clientCount || 0;

                // 2. KPI: Active Jobs (Pending or In Progress)
                const { count: jobCount } = await _supabase.from('bookings').select('*', { count: 'exact', head: true }).in('status', ['pending', 'in_progress']);
                document.getElementById('stat-active-jobs').innerText = jobCount || 0;

                // 3. KPI: Pending Reviews
                const { count: reviewCount } = await _supabase.from('reviews').select('*', { count: 'exact', head: true }).eq('is_approved', false);
                document.getElementById('stat-pending-reviews').innerText = reviewCount || 0;

                // 4. CHART: Growth Trajectory (Last 6 Months)
                // Get all bookings from last 6 months
                const sixMonthsAgo = new Date();
                sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);

                const { data: bookings } = await _supabase
                    .from('bookings')
                    .select('created_at')
                    .gte('created_at', sixMonthsAgo.toISOString())
                    .order('created_at');

                // Process Data for Chart
                const monthCounts = {};
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

                // Initialize last 6 months with 0
                for (let i = 5; i >= 0; i--) {
                    const d = new Date();
                    d.setMonth(d.getMonth() - i);
                    const key = `${months[d.getMonth()]} ${d.getFullYear()}`;
                    monthCounts[key] = 0;
                }

                if (bookings) {
                    bookings.forEach(b => {
                        const d = new Date(b.created_at);
                        const key = `${months[d.getMonth()]} ${d.getFullYear()}`;
                        if (monthCounts[key] !== undefined) monthCounts[key]++;
                    });
                }

                const labels = Object.keys(monthCounts);
                const dataPoints = Object.values(monthCounts);

                // Render Chart
                const ctx = document.getElementById('growthChart')?.getContext('2d');
                if (ctx) {
                    if (growthChartInstance) growthChartInstance.destroy();

                    // Create Gradient
                    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                    gradient.addColorStop(0, 'rgba(147, 51, 234, 0.5)'); // Purple
                    gradient.addColorStop(1, 'rgba(147, 51, 234, 0)');

                    growthChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Monthly Bookings',
                                data: dataPoints,
                                borderColor: '#9333ea',
                                backgroundColor: gradient,
                                borderWidth: 3,
                                pointBackgroundColor: '#fff',
                                pointBorderColor: '#9333ea',
                                pointBorderWidth: 2,
                                pointRadius: 6,
                                pointHoverRadius: 8,
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                    titleFont: { family: "'Plus Jakarta Sans', sans-serif", size: 13 },
                                    bodyFont: { family: "'Plus Jakarta Sans', sans-serif", size: 13 },
                                    padding: 12,
                                    cornerRadius: 8,
                                    displayColors: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: { display: true, borderDash: [5, 5], color: '#f1f5f9' },
                                    ticks: { font: { family: "'Plus Jakarta Sans', sans-serif", size: 10 }, color: '#94a3b8' }
                                },
                                x: {
                                    grid: { display: false },
                                    ticks: { font: { family: "'Plus Jakarta Sans', sans-serif", size: 10 }, color: '#94a3b8' }
                                }
                            }
                        }
                    });
                }

                // 5. PULSE FEED: Recent Activity
                const { data: logs } = await _supabase
                    .from('activity_logs')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(10);

                const pulseContainer = document.getElementById('pulse-feed-container');
                if (pulseContainer && logs) {
                    if (logs.length === 0) {
                        pulseContainer.innerHTML = '<p class="text-[10px] text-slate-400 text-center italic mt-10">Waiting for activity...</p>';
                    } else {
                        pulseContainer.innerHTML = logs.map(l => {
                            const timeAgo = getTimeAgo(l.created_at);
                            const icon = l.action_type.includes('CREATE') ? 'fa-plus text-emerald-500' :
                                l.action_type.includes('UPDATE') ? 'fa-pen-to-square text-blue-500' :
                                    l.action_type.includes('DELETE') ? 'fa-trash-can text-rose-500' : 'fa-bolt text-purple-500';

                            return `
                                <div class="flex gap-4 group cursor-default">
                                    <div class="w-8 h-8 rounded-xl bg-slate-50 flex-shrink-0 flex items-center justify-center text-[10px] group-hover:bg-white group-hover:shadow-md transition-all">
                                        <i class="fa-solid ${icon}"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-[10px] font-bold text-slate-800 line-clamp-2 leading-tight">${l.description}</p>
                                        <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest mt-1">${timeAgo}</p>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }

            } catch (err) {
                console.error("Analytics Error:", err);
            }
        }

        // Helper: Time Ago Utility
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + "y";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + "mo";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + "d";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + "h";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + "m";
            return "Just Now";
        }

        async function checkSession() {
            const { data: { session }, error } = await _supabase.auth.getSession();

            if (error || !session) {
                window.location.href = 'index.html';
                return;
            }

            try {
                const { data: profile, error: profileError } = await _supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', session.user.id)
                    .single();

                if (profileError || profile.role !== 'admin') {
                    window.location.href = 'client_dashboard.html';
                    return;
                }

                // Update UI with admin name (fallback to auth metadata if profile field is empty)
                const meta = session.user.user_metadata || {};
                const adminName = profile.full_name || meta.full_name || 'Administrator';

                const adminNameEl = document.getElementById('admin-name');
                if (adminNameEl) {
                    adminNameEl.innerText = adminName;
                }
            } catch (error) {
                console.error('Session check error:', error);
                window.location.href = 'index.html';
            }
        }
        // checkSession(); // Replaced by the new initialization block below

        function handleLogout() {
            console.log(' Logout button clicked!');

            try {
                // Show what we're clearing
                console.log('Before logout - authToken:', localStorage.getItem('authToken'));
                console.log('Before logout - user:', localStorage.getItem('user'));

                // Clear authentication data
                localStorage.removeItem('authToken');
                localStorage.removeItem('user');

                // Verify cleared
                console.log('After logout - authToken:', localStorage.getItem('authToken'));
                console.log('After logout - user:', localStorage.getItem('user'));

                console.log(' Logout successful! Redirecting...');

                // Redirect to login page
                window.location.href = 'index.html';
            } catch (error) {
                console.error(' Logout error:', error);
                alert('Logout failed: ' + error.message);
            }
        }

        let currentSearchTerm = '';

        function globalSearch(query) {
            currentSearchTerm = query.toLowerCase();

            // Re-fetch or Re-render the active tab
            // Determine active tab by checking visible section
            if (!document.getElementById('accounts-section').classList.contains('hidden')) fetchClients();
            else if (!document.getElementById('bookings-section').classList.contains('hidden')) fetchBookings();
            else if (!document.getElementById('reviews-section').classList.contains('hidden')) fetchReviews();
            else if (!document.getElementById('branches-section').classList.contains('hidden')) fetchBranches();
            else if (!document.getElementById('services-section').classList.contains('hidden')) fetchServices();
            else if (!document.getElementById('logs-section').classList.contains('hidden')) fetchLogs();
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('adminSidebar');
            const backdrop = document.getElementById('sidebarForwardDrop');
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                if (backdrop) backdrop.classList.remove('hidden');
            } else {
                closeSidebar();
            }
        }

        function closeSidebar() {
            const sidebar = document.getElementById('adminSidebar');
            const backdrop = document.getElementById('sidebarForwardDrop');
            if (sidebar) sidebar.classList.add('-translate-x-full');
            if (backdrop) backdrop.classList.add('hidden');
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById(tab + '-section');
            if (target) target.classList.remove('hidden');

            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            const btn = document.getElementById('btn-' + tab);
            if (btn) btn.classList.add('active');

            const titles = {
                'overview': 'Business Intelligence',
                'accounts': 'Client Database',
                'schedule': 'Service Calendar',
                'bookings': 'Active Service Orders',
                'reviews': 'Customer Trust',
                'branches': 'Service Hubs',
                'services': 'Service Menu',
                'portfolio': 'Work Showcase',
                'media': 'Media Archive',
                'logs': 'System Audit Trail'
            };
            const titleEl = document.getElementById('section-title');
            if (titleEl) titleEl.innerText = titles[tab] || 'Operations Hub';

            // Auto-close sidebar on mobile after selection
            if (window.innerWidth < 1024) closeSidebar();

            // Render Logic
            if (tab === 'overview') fetchAnalytics();
            else if (tab === 'accounts') fetchClients();
            else if (tab === 'schedule') {
                if (!calendar) initCalendar();
                else calendar.refetchEvents();
            }
            else if (tab === 'bookings') fetchBookings();
            else if (tab === 'reviews') fetchReviews();
            else if (tab === 'branches') fetchBranches();
            else if (tab === 'services') fetchServices();
            else if (tab === 'portfolio') fetchPortfolio();
            else if (tab === 'media') fetchAllMedia();
            else if (tab === 'logs') fetchLogs();
        }

        let calendar = null;
        async function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            if (calendar) calendar.destroy();

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: async function (info, successCallback, failureCallback) {
                    try {
                        const { data, error } = await _supabase
                            .from('bookings')
                            .select(`
                        *,
                    profiles: user_id(full_name)
                        `)
                            .gte('preferred_date', info.startStr)
                            .lte('preferred_date', info.endStr);

                        if (error) throw error;

                        const events = data.map(b => {
                            // Combine date and time if both exist
                            let eventStart = b.preferred_date;
                            if (b.preferred_date && b.preferred_time) {
                                eventStart = `${b.preferred_date}T${b.preferred_time}`;
                            }

                            return {
                                title: `${b.profiles?.full_name || 'Client'}: ${b.service_type}`,
                                start: eventStart || b.created_at,
                                backgroundColor: b.status === 'confirmed' ? '#10b981' :
                                    b.status === 'completed' ? '#8b5cf6' : '#f59e0b',
                                extendedProps: b
                            };
                        });

                        successCallback(events);
                    } catch (error) {
                        console.error('Calendar error:', error);
                        failureCallback(error);
                    }
                },
                eventClick: function (info) {
                    const b = info.event.extendedProps;
                    showEventModal(b);
                }
            });
            calendar.render();
        }

        function showEventModal(b) {
            const modal = document.getElementById('event-modal');
            const project = document.getElementById('modal-project');
            const client = document.getElementById('modal-client');
            const time = document.getElementById('modal-time');
            const branch = document.getElementById('modal-branch');
            const badge = document.getElementById('modal-status-badge');

            project.innerText = b.service_type;
            client.innerText = `Client: ${b.profiles?.full_name || 'N/A'}`;

            // Format date and time properly
            let displayDate = 'Date not set';
            if (b.preferred_date) {
                const dateObj = new Date(b.preferred_date);
                if (b.preferred_time) {
                    displayDate = `${dateObj.toLocaleDateString([], { dateStyle: 'long' })} at ${b.preferred_time}`;
                } else {
                    displayDate = dateObj.toLocaleDateString([], { dateStyle: 'long' });
                }
            }
            time.innerText = displayDate;
            branch.innerText = b.location || 'Location not specified';

            badge.innerText = b.status;
            if (b.status === 'confirmed') {
                badge.className = "px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-emerald-100 text-emerald-700";
            } else if (b.status === 'completed') {
                badge.className = "px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-purple-100 text-purple-700";
            } else {
                badge.className = "px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-amber-100 text-amber-700";
            }

            modal.classList.add('active');
        }

        function closeEventModal() {
            document.getElementById('event-modal').classList.remove('active');
        }

        async function fetchClients() {
            const tbody = document.getElementById('client-table-body');
            if (!tbody) return;

            try {
                const { data: profiles, error } = await _supabase
                    .from('profiles')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const { data: { session } } = await _supabase.auth.getSession();
                const currentUserId = session?.user?.id;

                let displayProfiles = profiles || [];

                // Client-side search filtering
                if (currentSearchTerm) {
                    displayProfiles = displayProfiles.filter(p =>
                        (p.full_name && p.full_name.toLowerCase().includes(currentSearchTerm)) ||
                        (p.email && p.email.toLowerCase().includes(currentSearchTerm)) ||
                        (p.address && p.address.toLowerCase().includes(currentSearchTerm))
                    );
                }

                if (!displayProfiles || displayProfiles.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" class="p-20 text-center"><div class="flex flex-col items-center gap-4 opacity-30"><i class="fa-solid fa-folder-open text-4xl"></i><p class="font-black uppercase tracking-[0.3em] text-[10px]">No records found matching "${currentSearchTerm}"</p></div></td></tr>`;
                    return;
                }

                tbody.innerHTML = displayProfiles.map(u => `
                <tr class="hover:bg-slate-50/50 transition-colors group">
                        <td class="p-6" data-label="Identity">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center font-black text-slate-400 text-[10px] uppercase shadow-sm border border-slate-200/50 group-hover:bg-purple-600 group-hover:text-white group-hover:border-purple-600 transition-all duration-300 overflow-hidden">
                                    ${u.avatar_url ? `<img src="${u.avatar_url}" class="w-full h-full object-cover">` : (u.full_name ? u.full_name.charAt(0) : '?')}
                                </div>
                                <div>
                                    <div class="font-bold text-slate-900 leading-tight">${u.full_name || 'No Name'}</div>
                                    <div class="text-[9px] font-black text-slate-400 uppercase tracking-widest mt-0.5">ID: ${u.id.substring(0, 8)}</div>
                                </div>
                            </div>
                        </td>
                        <td class="p-6" data-label="Contact">
                            <div class="flex flex-col gap-1.5">
                                <div class="text-[11px] font-medium text-slate-600 flex items-center gap-2">
                                    <i class="fa-solid fa-envelope text-[9px] text-slate-300"></i> ${u.email || 'No Email'}
                                </div>
                                <div class="text-[10px] text-slate-400 flex items-center gap-2">
                                    <i class="fa-solid fa-location-dot text-[9px] text-slate-300"></i> ${u.address || 'Address Unset'}
                                </div>
                            </div>
                        </td>
                        <td class="p-6" data-label="Role">
                            <button onclick="toggleUserRole('${u.id}', '${u.full_name}', '${u.role}')" 
                                class="px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-widest border transition-all hover:scale-105 active:scale-95 ${u.role === 'admin' ? 'bg-indigo-100 text-indigo-700 border-indigo-200 hover:bg-indigo-200' : 'bg-emerald-100 text-emerald-700 border-emerald-200 hover:bg-emerald-200'}"
                                title="${u.role === 'admin' ? 'Demote to Client' : 'Promote to Admin'}">
                                ${u.role}
                            </button>
                        </td>
                        <td class="p-6" data-label="Joined">
                            <div class="text-[11px] font-bold text-slate-600">
                                ${new Date(u.created_at).toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' })}
                            </div>
                        </td>
                        <td class="p-6 text-right" data-label="Actions">
                            ${u.id !== currentUserId ? `
                                <button onclick="deleteClient('${u.id}', '${u.full_name}')" class="w-9 h-9 rounded-xl bg-slate-50 text-slate-400 hover:bg-rose-500 hover:text-white transition-all flex items-center justify-center ml-auto border border-slate-100 hover:border-rose-500 shadow-sm hover:shadow-rose-500/20">
                                    <i class="fa-solid fa-trash-can text-xs"></i>
                                </button>
                            ` : '<span class="px-3 py-1 border border-slate-100 bg-slate-50 text-slate-400 text-[8px] font-black uppercase tracking-widest rounded-full opacity-60">Master Admin</span>'}
                        </td>
                    </tr >
                    `).join('');

            } catch (error) {
                console.error('Error fetching clients:', error);
                if (tbody) tbody.innerHTML = `<tr><td colspan="5" class="p-12 text-center text-rose-500 font-bold uppercase tracking-widest text-[10px]">Error loading profiles: ${error.message}</td></tr>`;
            }
        }

        async function deleteClient(userId, userName) {
            const confirmed = await showNiceModal({
                title: "Delete Account",
                message: `Are you sure you want to permanently delete "${userName}" ? NOTE : Supabase client - side deletion is restricted.Please use Supabase Dashboard for full deletion.`,
                type: "danger",
                confirmText: "Delete Profile",
                cancelText: "Cancel"
            });

            if (!confirmed) return;

            try {
                // We can delete from the 'profiles' table, but the 'auth.users' entry remains unless we use a service role or RPC
                const { error } = await _supabase
                    .from('profiles')
                    .delete()
                    .eq('id', userId);

                if (error) throw error;

                await logActivity('DELETE_CLIENT', `Deleted client profile: ${userName}`, userId);

                await showNiceModal({
                    title: "Success",
                    message: "Profile has been removed from the database.",
                    type: "success"
                });

                fetchClients();
            } catch (error) {
                console.error('Delete error:', error);
                await showNiceModal({
                    title: "Error",
                    message: "Failed to delete account: " + error.message,
                    type: "danger"
                });
            }
        }

        async function toggleUserRole(userId, userName, currentRole) {
            const newRole = currentRole === 'admin' ? 'client' : 'admin';
            const actionText = newRole === 'admin' ? 'Promote to Admin' : 'Demote to Client';

            const confirmed = await showNiceModal({
                title: "Change User Role",
                message: `Are you sure you want to ${actionText.toLowerCase()} for "${userName}"? \n\n${newRole === 'admin' ? ' Admins have full access to this dashboard.' : ' Clients are restricted to the booking portal.'}`,
                type: "warning",
                confirmText: actionText,
                cancelText: "Cancel"
            });

            if (!confirmed) return;

            try {
                const { error } = await _supabase
                    .from('profiles')
                    .update({ role: newRole })
                    .eq('id', userId);

                if (error) throw error;

                await logActivity('CHANGE_ROLE', `Changed role for ${userName} to ${newRole}`, userId);

                await showNiceModal({
                    title: "Role Updated",
                    message: `${userName} is now a ${newRole.toUpperCase()}.`,
                    type: "success"
                });

                fetchClients();
            } catch (error) {
                console.error('Role update error:', error);
                await showNiceModal({
                    title: "Error",
                    message: "Failed to update role: " + error.message,
                    type: "danger"
                });
            }
        }


        async function fetchBookings() {
            const tbody = document.getElementById('booking-table-body');

            try {
                const { data, error } = await _supabase
                    .from('bookings')
                    .select(`
                    *,
                    profiles: user_id(full_name, email),
                        reviews(rating)
                            `)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                let displayBookings = data || [];

                // Client-side search filtering for bookings
                if (currentSearchTerm) {
                    displayBookings = displayBookings.filter(b =>
                        (b.profiles?.full_name && b.profiles.full_name.toLowerCase().includes(currentSearchTerm)) ||
                        (b.service_type && b.service_type.toLowerCase().includes(currentSearchTerm)) ||
                        (b.status && b.status.toLowerCase().includes(currentSearchTerm)) ||
                        (b.id && b.id.toString().includes(currentSearchTerm))
                    );
                }

                if (!displayBookings || displayBookings.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" class="p-20 text-center"><div class="flex flex-col items-center gap-4 opacity-30"><i class="fa-solid fa-calendar-xmark text-4xl"></i><p class="font-black uppercase tracking-[0.3em] text-[10px]">No bookings found matching "${currentSearchTerm}"</p></div></td></tr>`;
                    return;
                }

                tbody.innerHTML = displayBookings.map(b => `
                    <tr class="hover:bg-slate-50/50 transition-colors">
                        <td class="p-6" data-label="Service">
                            <div class="font-bold text-slate-900">${b.profiles?.full_name || 'Deleted Client'}</div>
                            <div class="flex flex-col gap-0.5 mt-1">
                                <span class="text-[11px] font-black text-purple-600 uppercase tracking-tight">${b.service_type}</span>
                                ${b.reviews && b.reviews[0] ? `
                                    <div class="flex gap-0.5 text-amber-400 text-[8px] mt-1">
                                        ${''.repeat(b.reviews[0].rating)}${''.repeat(5 - b.reviews[0].rating)}
                                    </div>
                                ` : ''}
                            </div>
                        </td>
                        <td class="p-6 text-xs text-slate-500" data-label="Timing">
                            <div class="flex items-center gap-1.5 mb-1 font-black text-slate-400 uppercase tracking-tighter">
                                <i class="fa-solid fa-location-dot"></i> ${b.location || 'Not specified'}
                            </div>
                            <div class="mt-1 font-bold text-slate-900">
                                ${b.preferred_date ? new Date(b.preferred_date).toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' }) : 'No Date'}
                                <span class="text-slate-300 mx-1">|</span>
                                ${b.preferred_time || 'No Time'}
                            </div>
                        </td>
                        <td class="p-6" data-label="Photos">
                            <div class="flex gap-1">
                                ${(function () {
                        try {
                            const photoData = b.photo_urls || b.photo_url || '[]';
                            const urls = Array.isArray(photoData) ? photoData : JSON.parse(photoData);

                            if (!Array.isArray(urls) || urls.length === 0) {
                                return '<span class="text-slate-300 italic text-[10px]">None</span>';
                            }

                            return urls.slice(0, 5).map(item => {
                                const url = typeof item === 'object' ? item.url : item;
                                const isVideo = url.toLowerCase().match(/\.(mp4|mov|webm|ogg|m4v)$/) || url.includes('/video/');
                                const thumbUrl = url.includes('imagekit.io') ? `${url}?tr=w-100,h-100,c-at_max` : url;

                                if (isVideo) {
                                    return `<div class="relative w-10 h-10 rounded-lg overflow-hidden border border-slate-200 cursor-pointer hover:border-purple-400 transition-all" onclick="openLightbox('${url}')">
                                                <video src="${thumbUrl}" class="w-full h-full object-cover"></video>
                                                <div class="absolute inset-0 flex items-center justify-center bg-black/30 text-white text-xs">
                                                    <i class="fa-solid fa-play"></i>
                                                </div>
                                            </div>`;
                                }
                                return `<img src="${thumbUrl}" class="w-10 h-10 rounded-lg object-cover border border-slate-200 cursor-pointer hover:border-purple-400 hover:scale-110 transition-all" onclick="openLightbox('${url}')">`;
                            }).join('') + (urls.length > 5 ? `<div class="w-10 h-10 rounded-lg bg-slate-100 border border-slate-200 flex items-center justify-center text-[8px] font-black text-slate-400">+${urls.length - 5}</div>` : '');
                        } catch (e) {
                            return '<span class="text-slate-300 italic text-[10px]">None</span>';
                        }
                    })()}
                            </div>
                        </td>
                        <td class="p-6" data-label="Status">
                            <span class="px-3 py-1 rounded-lg text-[10px] font-black uppercase tracking-widest 
                                ${b.status === 'confirmed' ? 'bg-emerald-100 text-emerald-700' :
                        b.status === 'completed' ? 'bg-purple-100 text-purple-700' :
                            b.status === 'cancelled' ? 'bg-rose-100 text-rose-700' :
                                b.status === 'in_progress' ? 'bg-blue-100 text-blue-700' :
                                    'bg-amber-100 text-amber-700'}">
                                ${b.status}
                            </span>
                        </td>
                        <td class="p-6 text-right" data-label="Manage">
                            <div class="flex justify-end gap-2">
                                 ${b.status === 'pending' ? `
                                    <button onclick="updateStatus('${b.id}', 'confirmed')" class="w-8 h-8 rounded-lg bg-emerald-50 text-emerald-600 hover:bg-emerald-600 hover:text-white transition-all flex items-center justify-center" title="Confirm Booking"><i class="fa-solid fa-check"></i></button>
                                    <button onclick="updateStatus('${b.id}', 'cancelled')" class="w-8 h-8 rounded-lg bg-rose-50 text-rose-500 hover:bg-rose-500 hover:text-white transition-all flex items-center justify-center" title="Cancel Booking"><i class="fa-solid fa-xmark"></i></button>
                                ` : b.status === 'confirmed' ? `
                                    <button onclick="updateStatus('${b.id}', 'in_progress')" class="w-8 h-8 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white transition-all flex items-center justify-center" title="Start Service"><i class="fa-solid fa-wrench"></i></button>
                                ` : b.status === 'in_progress' ? `
                                    <button onclick="updateStatus('${b.id}', 'completed')" class="w-8 h-8 rounded-lg bg-purple-50 text-purple-600 hover:bg-purple-600 hover:text-white transition-all flex items-center justify-center" title="Complete Service"><i class="fa-solid fa-flag-checkered"></i></button>
                                ` : ''}
                                <button onclick="resendEmailNotification('${b.id}')" class="w-8 h-8 rounded-lg bg-slate-50 text-slate-400 hover:bg-slate-900 hover:text-white transition-all flex items-center justify-center" title="Resend Notification"><i class="fa-solid fa-envelope text-[10px]"></i></button>
                            </div>
                        </td>
                    </tr >
                    `).join('');

            } catch (error) {
                console.error('Error fetching bookings:', error);
                tbody.innerHTML = `<tr><td colspan="5" class="p-12 text-center text-rose-500 font-bold uppercase tracking-widest text-[10px]">Error loading bookings: ${error.message}</td></tr>`;
            }
        }

        async function updateStatus(id, newStatus) {
            try {
                // 1. Fetch current booking details (including client email) first
                const { data: booking, error: fetchError } = await _supabase
                    .from('bookings')
                    .select('*, profiles:user_id (full_name, email)')
                    .eq('id', id)
                    .single();

                if (fetchError) throw fetchError;

                // 2. Perform the status update in the database
                const { error: updateError } = await _supabase
                    .from('bookings')
                    .update({ status: newStatus })
                    .eq('id', id);

                if (updateError) throw updateError;

                // 3. Send In-App Notification (Fixes Gmail Scope Error)
                await sendInAppNotification(
                    booking.user_id,
                    "Booking Status Update",
                    `Your booking #${booking.id} (${booking.service_type}) is now ${newStatus.toUpperCase()}.`,
                    newStatus === 'cancelled' ? 'danger' : (newStatus === 'completed' ? 'success' : 'info')
                );

                // 4. Log Activity
                await logActivity('UPDATE_STATUS', `Updated booking #${booking.id} (${booking.profiles.full_name}) to ${newStatus}`, booking.id.toString());

                await showNiceModal({
                    title: "Status Transmitted",
                    message: `Booking updated to ${newStatus.toUpperCase()}. In-app notification sent to client.`,
                    type: "success"
                });

                // Refresh UI components
                fetchBookings();
                if (calendar && typeof calendar.refetchEvents === 'function') {
                    calendar.refetchEvents();
                }

            } catch (error) {
                console.error('Operation Failed:', error);
                await showNiceModal({
                    title: "System Error",
                    message: "Failed to update booking status: " + error.message,
                    type: "danger"
                });
            }
        }

        async function resendEmailNotification(id) {
            try {
                // 1. Fetch current booking details from Supabase
                const { data: booking, error: fetchError } = await _supabase
                    .from('bookings')
                    .select('*, profiles:user_id (full_name, email)')
                    .eq('id', id)
                    .single();

                if (fetchError) throw fetchError;

                if (!booking || !booking.profiles || !booking.profiles.email) {
                    throw new Error("Client contact information unavailable.");
                }

                // trigger notification manually
                await sendInAppNotification(
                    booking.user_id,
                    "Booking Alert",
                    `RE-SENT: Your booking #${booking.id} is currently ${booking.status.toUpperCase()}.`,
                    'info'
                );

                showNiceModal({
                    title: "Signal Dispatched",
                    message: "An in-app alert has been manually re-sent to the client's dashboard.",
                    type: "success"
                });

            } catch (error) {
                console.error('Resend Failed:', error);
                await showNiceModal({
                    title: "System Error",
                    message: "Failed to dispatch email: " + error.message,
                    type: "danger"
                });
            }
        }

        // Send Email Notification function removed in favor of in-app notifications

        // --- Session Timeout (AFK Handler) ---
        function initSessionTimeout() {
            let timeout;
            // 1 Hour in milliseconds
            const TIMEOUT_DURATION = 3600000;

            function logoutUser() {
                showNiceModal({ title: 'Session Expired', message: 'You have been inactive for 1 hour. Logging out for security.', type: 'warning' });
                handleLogout();
            }

            function resetTimer() {
                clearTimeout(timeout);
                timeout = setTimeout(logoutUser, TIMEOUT_DURATION);
            }
            // Monitor events
            window.onload = resetTimer;
            document.onmousemove = resetTimer;
            document.onkeypress = resetTimer;
            document.onclick = resetTimer;
            document.onscroll = resetTimer;

            resetTimer();
        }

        initSessionTimeout();

        async function fetchReviews() {
            const tbody = document.getElementById('review-table-body');

            try {
                const { data, error } = await _supabase
                    .from('reviews')
                    .select(`
                    *,
                    profiles: user_id(full_name)
                        `)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!data || data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" class="p-20 text-center"><div class="flex flex-col items-center gap-4 opacity-30"><i class="fa-solid fa-comments text-4xl"></i><p class="font-black uppercase tracking-[0.3em] text-[10px]">No customer feedback found</p></div></td></tr>`;
                    return;
                }

                tbody.innerHTML = data.map(r => `
                    <tr class="hover:bg-slate-50/50 transition-colors">
                        <td class="p-6">
                            <div class="font-bold text-slate-900 text-xs">${r.profiles?.full_name || 'Anonymous'}</div>
                            <div class="flex gap-1 text-amber-400 mt-1 text-[8px]">
                                ${''.repeat(r.rating)}${''.repeat(5 - r.rating)}
                            </div>
                        </td>
                        <td class="p-6 italic text-slate-600 text-xs truncate max-w-[200px]" title="${r.comment}">"${r.comment}"</td>
                        <td class="p-6">
                            <div class="flex gap-1 justify-center">
                                 ${(function () {
                        try {
                            const photoData = r.photo_urls || '[]';
                            const urls = typeof photoData === 'string' ? JSON.parse(photoData) : photoData;
                            if (!Array.isArray(urls) || urls.length === 0) return '<span class="text-slate-300 italic text-[8px]">None</span>';

                            return urls.slice(0, 3).map(item => {
                                const url = typeof item === 'object' ? item.url : item;
                                if (!url) return '';
                                return `<img src="${url}" class="w-8 h-8 rounded-lg object-cover border border-slate-200 cursor-pointer" onclick="openLightbox('${url}')">`;
                            }).join('');
                        } catch (e) { return '<span class="text-slate-300 italic text-[8px]">None</span>'; }
                    })()}
                            </div>
                        </td>
                        <td class="p-6 text-center">
                            <span class="px-3 py-1 rounded-lg text-[9px] font-black uppercase tracking-widest ${r.is_approved ? 'bg-emerald-500 text-white' : 'bg-rose-500 text-white'}">
                                ${r.is_approved ? 'POST' : 'HIDE'}
                            </span>
                        </td>
                        <td class="p-6 text-right">
                            <button onclick="toggleReviewStatus('${r.id}', ${r.is_approved})" 
                                class="px-4 py-2 rounded-xl border-2 ${r.is_approved ? 'border-rose-100 text-rose-500 hover:bg-rose-50' : 'border-emerald-100 text-emerald-600 hover:bg-emerald-50'} font-black text-[9px] uppercase transition-all">
                                ${r.is_approved ? 'Hide This' : 'Post Now'}
                            </button>
                        </td>
                    </tr >
                    `).join('');

            } catch (error) {
                console.error('Error fetching reviews:', error);
                tbody.innerHTML = `<tr><td colspan="5" class="p-12 text-center text-rose-500 font-bold uppercase tracking-widest text-[10px]">Error loading reviews: ${error.message}</td></tr>`;
            }
        }

        async function toggleReviewStatus(id, currentApproved) {
            try {
                // Determine new state
                const nextState = !currentApproved;

                // 1. Fetch review details to get user_id
                const { data: review, error: fetchError } = await _supabase
                    .from('reviews')
                    .select('user_id, rating')
                    .eq('id', id)
                    .single();

                if (fetchError) throw fetchError;

                // 2. Update status
                const { error } = await _supabase
                    .from('reviews')
                    .update({
                        is_approved: nextState,
                        is_featured: nextState
                    })
                    .eq('id', id);

                if (error) throw error;

                // 3. Notify user
                if (nextState) {
                    await sendInAppNotification(
                        review.user_id,
                        "Review Published!",
                        `Your ${review.rating}-star review has been approved and published to our website. Thank you for your feedback!`,
                        'success'
                    );
                }

                fetchReviews();
            } catch (error) {
                console.error('Update status error:', error);
                showNiceModal({ title: 'System Error', message: 'Failed to synchronize feedback status.', type: 'danger' });
            }
        }

        async function fetchBranches() {
            const tbody = document.getElementById('branch-table-body');

            try {
                const { data, error } = await _supabase
                    .from('branches')
                    .select('*')
                    .order('name');

                if (error) throw error;

                if (!data || data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="3" class="p-20 text-center"><div class="flex flex-col items-center gap-4 opacity-30"><i class="fa-solid fa-map-location-dot text-4xl"></i><p class="font-black uppercase tracking-[0.3em] text-[10px]">No branch locations registered</p></div></td></tr>`;
                    return;
                }

                tbody.innerHTML = data.map(b => `
                    <tr class="hover:bg-slate-50/50 transition-colors">
                        <td class="p-6 font-bold uppercase tracking-tighter">${b.name}</td>
                        <td class="p-6 text-slate-500 text-sm italic">${b.address}</td>
                        <td class="p-6 text-right">
                            <button onclick="deleteResource('branches', '${b.id}')" class="text-rose-500 hover:scale-110 transition-transform"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr >
                    `).join('');

            } catch (error) {
                console.error('Error fetching branches:', error);
                tbody.innerHTML = `<tr><td colspan="3" class="p-12 text-center text-rose-500 font-bold uppercase tracking-widest text-[10px]">Error loading branches</td></tr>`;
            }
        }

        async function addBranch() {
            const name = document.getElementById('branch-name').value;
            const address = document.getElementById('branch-address').value;

            if (!name || !address) return showNiceModal({ title: 'Missing Info', message: 'Please fill all fields.', type: 'warning' });

            try {
                const { error } = await _supabase
                    .from('branches')
                    .insert([{ name, address }]);

                if (error) throw error;

                document.getElementById('branch-name').value = '';
                document.getElementById('branch-address').value = '';
                fetchBranches();

                showNiceModal({
                    title: "Success",
                    message: "New branch added successfully.",
                    type: "success"
                });

            } catch (error) {
                showNiceModal({ title: 'Error', message: 'Error adding branch: ' + error.message, type: 'danger' });
            }
        }

        async function fetchPortfolio() {
            const tbody = document.getElementById('portfolio-table-body');
            if (!tbody) return;

            try {
                const { data, error } = await _supabase
                    .from('portfolio')
                    .select('*')
                    .order('display_order', { ascending: true });

                if (error) throw error;

                if (!data || data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" class="p-20 text-center"><div class="flex flex-col items-center gap-4 opacity-30"><i class="fa-solid fa-folder-open text-4xl"></i><p class="font-black uppercase tracking-[0.3em] text-[10px]">No projects in portfolio</p></div></td></tr>`;
                    return;
                }

                tbody.innerHTML = data.map(p => `
                    <tr class="hover:bg-slate-50/50 transition-colors group">
                        <td class="p-6">
                            <img src="${p.image_url}" class="w-20 h-20 rounded-2xl object-cover shadow-sm border border-slate-100 group-hover:scale-105 transition-transform duration-500 cursor-pointer" onclick="openLightbox('${p.image_url}')">
                        </td>
                        <td class="p-6">
                            <div class="font-bold text-slate-900 mb-1 capitalize">${p.title}</div>
                            <div class="text-[10px] text-slate-500 line-clamp-1 italic">"${p.description || 'No description provided.'}"</div>
                        </td>
                        <td class="p-6">
                            <div class="text-[10px] font-black text-indigo-600 bg-indigo-50 w-fit px-2 py-1 rounded-lg">#${p.display_order || 0}</div>
                        </td>
                        <td class="p-6 text-right">
                             <button onclick="deleteResource('portfolio', '${p.id}')" class="w-9 h-9 rounded-xl bg-slate-50 text-slate-400 hover:bg-rose-500 hover:text-white transition-all flex items-center justify-center ml-auto border border-slate-100 hover:border-rose-500 shadow-sm hover:shadow-rose-500/20">
                                <i class="fa-solid fa-trash-can text-xs"></i>
                            </button>
                        </td>
                    </tr >
                    `).join('');

                // Automatically remove "Luxury Sedan Restoration" if found (requested task)
                const target = data.find(p => p.title && p.title.toLowerCase().includes('luxury sedan restoration'));
                if (target) {
                    console.log('Automated cleanup: Removing Luxury Sedan Restoration');
                    _supabase.from('portfolio').delete().eq('id', target.id).then(() => fetchPortfolio());
                }

            } catch (error) {
                console.error('Error fetching portfolio:', error);
                tbody.innerHTML = `<tr><td colspan="4" class="p-12 text-center text-rose-500 font-bold uppercase tracking-widest text-[10px]">Error loading portfolio</td></tr>`;
            }
        }

        function previewPortfolioImage(input) {
            const container = document.getElementById('portfolio-preview-container');
            const preview = document.getElementById('portfolio-preview-img');
            const label = document.getElementById('portfolio-image-label');

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    container.classList.remove('hidden');
                    label.innerText = input.files[0].name;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function addPortfolioItem() {
            const title = document.getElementById('portfolio-title').value;
            const desc = document.getElementById('portfolio-desc').value;
            const fileInput = document.getElementById('portfolio-image');

            if (!title) return showNiceModal({ title: 'System Warning', message: 'Project Title is required.', type: 'warning' });
            if (!fileInput.files || !fileInput.files[0]) return showNiceModal({ title: 'System Warning', message: 'Visual asset required for portfolio inclusion.', type: 'warning' });

            try {
                // Determine next display order
                const { data: currentPort } = await _supabase.from('portfolio').select('display_order').order('display_order', { ascending: false }).limit(1);
                const nextOrder = currentPort && currentPort.length > 0 ? (currentPort[0].display_order + 1) : 0;

                // Upload to ImageKit via our existing media system if available
                let finalImageUrl = '';
                if (window.ImageKitUpload) {
                    // Start upload notification
                    showNiceModal({ title: 'Uploading', message: 'Transferring visual asset to cloud storage...', type: 'info' });

                    const result = await window.ImageKitUpload.upload(fileInput.files[0], 'portfolio');
                    if (result && result.url) {
                        finalImageUrl = result.url;
                    } else {
                        throw new Error('Cloud storage transfer failed.');
                    }
                } else {
                    // Fallback to error if ImageKit isnt configured
                    throw new Error('Media upload system not initialized.');
                }

                const { error } = await _supabase
                    .from('portfolio')
                    .insert([{
                        title,
                        description: desc,
                        image_url: finalImageUrl,
                        display_order: nextOrder
                    }]);

                if (error) throw error;

                // Reset
                document.getElementById('portfolio-title').value = '';
                document.getElementById('portfolio-desc').value = '';
                document.getElementById('portfolio-image').value = '';
                document.getElementById('portfolio-preview-container').classList.add('hidden');
                document.getElementById('portfolio-image-label').innerText = 'Upload Image Assets';

                fetchPortfolio();

                showNiceModal({
                    title: "Authorized Success",
                    message: "Project published to public portfolio archive.",
                    type: "success"
                });

            } catch (error) {
                console.error('Portfolio add error:', error);
                showNiceModal({ title: 'System Error', message: 'Failed to publish project: ' + error.message, type: 'danger' });
            }
        }

        async function fetchServices() {
            const tbody = document.getElementById('service-table-body');

            try {
                const { data, error } = await _supabase
                    .from('services')
                    .select('*')
                    .order('name');

                if (error) throw error;

                let displayServices = data || [];

                // Client-side search filtering
                if (currentSearchTerm) {
                    displayServices = displayServices.filter(s =>
                        (s.name && s.name.toLowerCase().includes(currentSearchTerm)) ||
                        (s.description && s.description.toLowerCase().includes(currentSearchTerm)) ||
                        (s.price_fee && s.price_fee.toLowerCase().includes(currentSearchTerm))
                    );
                }

                if (!displayServices || displayServices.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" class="p-20 text-center"><div class="flex flex-col items-center gap-4 opacity-30"><i class="fa-solid fa-screwdriver-wrench text-4xl"></i><p class="font-black uppercase tracking-[0.3em] text-[10px]">No service catalog items found matching "${currentSearchTerm}"</p></div></td></tr>`;
                    return;
                }

                tbody.innerHTML = displayServices.map(s => `
                    <tr class="hover:bg-slate-50/50 transition-colors">
                        <td class="p-6 font-bold uppercase tracking-tighter">${s.name}</td>
                        <td class="p-6 text-slate-500 text-sm italic">${s.description || '-'}</td>
                        <td class="p-6 text-purple-600 font-black text-sm">${s.price_fee || 'N/A'}</td>
                        <td class="p-6 text-right">
                            <button onclick="deleteResource('services', '${s.id}')" class="text-rose-500 hover:scale-110 transition-transform"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr >
                    `).join('');

            } catch (error) {
                console.error('Error fetching services:', error);
                tbody.innerHTML = `<tr><td colspan="4" class="p-12 text-center text-rose-500 font-bold uppercase tracking-widest text-[10px]">Error loading services</td></tr>`;
            }
        }

        async function addService() {
            const name = document.getElementById('service-name').value;
            const desc = document.getElementById('service-desc').value;
            const fee = document.getElementById('service-fee').value;

            if (!name) return showNiceModal({ title: 'Required Field', message: 'Service Name is required.', type: 'warning' });

            try {
                const { error } = await _supabase
                    .from('services')
                    .insert([{ name, description: desc, price_fee: fee }]);

                if (error) throw error;

                document.getElementById('service-name').value = '';
                document.getElementById('service-desc').value = '';
                document.getElementById('service-fee').value = '';
                fetchServices();

                showNiceModal({
                    title: "Success",
                    message: "New service added successfully.",
                    type: "success"
                });

            } catch (error) {
                showNiceModal({ title: 'Error', message: 'Error adding service: ' + error.message, type: 'danger' });
            }
        }

        async function deleteResource(table, id) {
            const confirmed = await showNiceModal({
                title: "Erase Record",
                message: "Are you sure you want to delete this resource? This cannot be reversed.",
                type: "danger",
                confirmText: "Delete Now",
                cancelText: "Cancel"
            });

            if (!confirmed) return;

            try {
                if (table === 'profiles') {
                    // Call Edge Function to delete from Auth (which should cascade to profiles too)
                    const response = await fetch('https://glnzltetqxpvxsoqwerz.supabase.co/functions/v1/delete-user-account', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        },
                        body: JSON.stringify({ user_id: id })
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error || 'Failed to delete user account');
                    }

                } else {
                    // Standard delete for other resources
                    const { error } = await _supabase
                        .from(table)
                        .delete()
                        .eq('id', id);

                    if (error) throw error;
                }

                if (table === 'branches') fetchBranches();
                else if (table === 'services') fetchServices();
                else if (table === 'portfolio') fetchPortfolio();
                else if (table === 'reviews') fetchReviews();
                else if (table === 'bookings') fetchBookings();
                else if (table === 'profiles') fetchClients();

                showNiceModal({
                    title: "Deleted",
                    message: "Record removed successfully.",
                    type: "success"
                });

            } catch (error) {
                showNiceModal({ title: 'Error', message: 'Error deleting resource: ' + error.message, type: 'danger' });
            }
        }

        async function fetchAllMedia() {
            const grid = document.getElementById('media-vault-container');
            if (!grid) return;

            grid.innerHTML = '<div class="col-span-full p-20 text-center text-slate-400 font-black uppercase tracking-widest text-xs">Cataloging system media...</div>';

            try {
                // Fetch photos from both bookings and reviews with robust selection
                const [bookingsRes, reviewsRes, portfolioRes] = await Promise.all([
                    _supabase.from('bookings').select('*, profiles:user_id(full_name)'),
                    _supabase.from('reviews').select('*, profiles:user_id(full_name)'),
                    _supabase.from('portfolio').select('*')
                ]);

                const bookings = bookingsRes.data;
                const reviews = reviewsRes.data;
                const portfolio = portfolioRes.data;

                let allMedia = [];

                // Process Booking Media
                if (bookings && bookings.length > 0) {
                    bookings.forEach(b => {
                        try {
                            const parse = (val) => {
                                if (!val) return [];
                                if (Array.isArray(val)) return val;
                                if (typeof val === 'string' && val.trim() !== '' && val !== '[]') {
                                    if (val.startsWith('[') || val.startsWith('{')) {
                                        try { return JSON.parse(val); } catch (e) { return [val]; }
                                    }
                                    return [val];
                                }
                                return [];
                            };

                            const urls = [...parse(b.photo_url), ...parse(b.photo_urls)];

                            urls.forEach(item => {
                                if (!item) return;
                                const url = typeof item === 'object' ? item.url : item;
                                const fileId = typeof item === 'object' ? item.fileId : null;
                                if (url) {
                                    allMedia.push({
                                        url,
                                        fileId,
                                        client: b.profiles?.full_name || 'System Client',
                                        type: b.service_type || 'Service Record',
                                        sourceTable: 'bookings',
                                        recordId: b.id,
                                        isPublic: true
                                    });
                                }
                            });
                        } catch (e) { console.error('Booking row parse error:', b.id, e); }
                    });
                }

                // Process Review Media
                if (reviews && reviews.length > 0) {
                    reviews.forEach(r => {
                        try {
                            const parse = (val) => {
                                if (!val) return [];
                                if (Array.isArray(val)) return val;
                                if (typeof val === 'string' && val.trim() !== '' && val !== '[]') {
                                    if (val.startsWith('[') || val.startsWith('{')) {
                                        try { return JSON.parse(val); } catch (e) { return [val]; }
                                    }
                                    return [val];
                                }
                                return [];
                            };

                            const urls = [...parse(r.photo_url), ...parse(r.photo_urls)];

                            urls.forEach(item => {
                                if (!item) return;
                                const url = typeof item === 'object' ? item.url : item;
                                const fileId = typeof item === 'object' ? item.fileId : null;
                                if (url) {
                                    allMedia.push({
                                        url,
                                        fileId,
                                        client: r.profiles?.full_name || 'Public Feedback',
                                        type: 'Client Review',
                                        sourceTable: 'reviews',
                                        recordId: r.id,
                                        rating: r.rating,
                                        isPublic: r.is_approved
                                    });
                                }
                            });
                        } catch (e) { console.error('Review row parse error:', r.id, e); }
                    });
                }

                // Process Portfolio Media
                if (portfolio && portfolio.length > 0) {
                    portfolio.forEach(p => {
                        if (p.image_url) {
                            allMedia.push({
                                url: p.image_url,
                                client: 'Verified Portfolio',
                                type: 'Gallery Asset',
                                sourceTable: 'portfolio',
                                recordId: p.id,
                                isPublic: true,
                                title: p.title
                            });
                        }
                    });
                }

                if (allMedia.length === 0) {
                    document.getElementById('media-count').innerText = "0 Assets Discovered";
                    document.getElementById('storage-percent').innerText = "0%";
                    document.getElementById('storage-bar').style.width = "0%";
                    grid.innerHTML = '<div class="col-span-full p-20 text-center text-slate-400 font-black uppercase tracking-widest text-xs">No media files discovered.</div>';
                    return;
                }

                const MAX_CAPACITY = 1000;
                const usagePercent = Math.min(Math.round((allMedia.length / MAX_CAPACITY) * 100), 100);

                document.getElementById('media-count').innerText = `${allMedia.length} Assets Discovered`;
                document.getElementById('storage-percent').innerText = `${usagePercent}% Capacity Used`;
                document.getElementById('storage-bar').style.width = `${usagePercent}% `;

                const bar = document.getElementById('storage-bar');
                if (usagePercent > 90) bar.className = "h-full bg-rose-500 transition-all duration-1000";
                else if (usagePercent > 70) bar.className = "h-full bg-amber-500 transition-all duration-1000";
                else bar.className = "h-full bg-purple-600 transition-all duration-1000";

                grid.innerHTML = allMedia.map((m) => {
                    const isVideo = m.url.toLowerCase().match(/\.(mp4|mov|webm|ogg|m4v)$/);
                    return `
                    <div class="group relative aspect-square bg-white rounded-[32px] overflow-hidden border border-slate-100 shadow-sm hover:shadow-xl transition-all duration-500 border-2 hover:border-purple-500/50">
                            <div class="w-full h-full cursor-pointer" onclick="openLightbox('${m.url}')">
                                ${isVideo
                            ? `<video src="${m.url}" class="w-full h-full object-cover"></video><div class="absolute inset-0 flex items-center justify-center bg-black/20 text-white"><i class="fa-solid fa-play"></i></div>`
                            : `<img src="${m.url}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">`}
                            </div>
                            
                            <div class="absolute top-4 left-4 flex flex-col gap-2">
                                <span class="px-2 py-1 ${m.isPublic ? 'bg-emerald-500 text-white' : 'bg-amber-500 text-white'} text-[8px] font-black uppercase tracking-widest rounded-lg shadow-sm">
                                    ${m.isPublic ? 'Public' : 'Hidden'}
                                </span>
                            </div>

                            <div class="absolute inset-x-0 bottom-0 p-5 bg-gradient-to-t from-slate-900 via-slate-900/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                                <div class="flex items-center justify-between mb-1">
                                    <p class="text-[8px] font-black text-purple-400 uppercase tracking-widest">${m.type}</p>
                                    ${m.rating ? `<div class="flex gap-0.5 text-amber-400 text-[7px]">${''.repeat(m.rating)}${''.repeat(5 - m.rating)}</div>` : ''}
                                </div>
                                <p class="text-[10px] font-bold text-white uppercase tracking-tight">${m.client}</p>
                            </div>

                            <button onclick="removeSystemMedia('${m.url}', '${m.sourceTable}', '${m.recordId}', '${m.fileId || ''}')" 
                                class="absolute top-4 right-4 w-10 h-10 rounded-2xl bg-rose-500 hover:bg-rose-600 text-white shadow-lg shadow-rose-500/30 opacity-0 group-hover:opacity-100 transition-all flex items-center justify-center hover:scale-110 active:scale-95"
                                title="Purge Asset">
                                <i class="fa-solid fa-trash-can text-sm"></i>
                            </button>
                        </div>
                    `;
                }).join('');

            } catch (err) {
                grid.innerHTML = `<div class="col-span-full p-20 text-center text-rose-500 font-black uppercase tracking-widest text-xs">Storage Error: ${err.message}</div>`;
            }
        }



        async function removeSystemMedia(url, table, id, fileId = '') {
            const confirmed = await showNiceModal({
                title: "Remove Media",
                message: "Authority requested: Permanently remove this media reference from the system?",
                type: "danger",
                confirmText: "Remove Authority",
                cancelText: "Cancel"
            });
            if (!confirmed) return;

            try {
                // Determine the correct column name
                let col;
                if (table === 'portfolio') col = 'image_url';
                else if (table === 'bookings') col = 'photo_url';
                else col = 'photo_urls';

                const { data, error: fetchError } = await _supabase.from(table).select('*').eq('id', id).single();
                if (fetchError) throw fetchError;

                if (data) {
                    // Try to delete from Cloud first if fileId is present
                    if (fileId && fileId !== 'null' && fileId !== '') {
                        console.log('Sending Cloud Purge request for:', fileId);
                        await window.ImageKitUpload.deleteFromImageKit(fileId);
                    }
                    if (table === 'portfolio') {
                        // Portfolio is a single string, just clear it or delete record
                        const { error } = await _supabase.from(table).update({ image_url: '' }).eq('id', id);
                        if (error) throw error;
                    } else {
                        // Bookings/Reviews use JSON arrays
                        // Check both potential columns for bookings
                        const actualCol = (table === 'bookings' && data.photo_urls && !data.photo_url) ? 'photo_urls' : col;
                        const photoData = data[actualCol] || '[]';
                        let urls = Array.isArray(photoData) ? photoData : JSON.parse(photoData);

                        // Filter out based on URL or object containing the URL
                        urls = urls.filter(item => {
                            const itemUrl = typeof item === 'object' ? item.url : item;
                            return itemUrl !== url;
                        });

                        const updatePayload = {};
                        updatePayload[actualCol] = JSON.stringify(urls);

                        const { error } = await _supabase.from(table).update(updatePayload).eq('id', id);
                        if (error) throw error;
                    }

                    showNiceModal({ title: "Authorized", message: "Media reference has been purged from system and cloud storage.", type: "success" });
                    fetchAllMedia();
                }
            } catch (err) {
                showNiceModal({ title: "Error", message: err.message, type: "danger" });
            }
        }

        async function purgeOldMedia() {
            const confirmed = await showNiceModal({
                title: "Bulk Purge Authority",
                message: "This will permanently remove all PRIVATE media references older than 30 days. High storage impact. Confirm?",
                type: "danger",
                confirmText: "Authorize Bulk Purge",
                cancelText: "Cancel"
            });
            if (!confirmed) return;

            try {
                const now = new Date();
                const thirtyDaysAgo = new Date(now.setDate(now.getDate() - 30)).toISOString();

                // 1. Purge from Bookings (Private/Old)
                const { data: bookings } = await _supabase.from('bookings').select('id, photo_url, reviews(is_public)').lt('created_at', thirtyDaysAgo);
                if (bookings) {
                    for (const b of bookings) {
                        const isPublic = b.reviews && b.reviews[0] ? b.reviews[0].is_public : false;
                        if (!isPublic && b.photo_url && b.photo_url !== '[]') {
                            await _supabase.from('bookings').update({ photo_url: '[]' }).eq('id', b.id);
                        }
                    }
                }

                // 2. Purge from Reviews (Private/Old)
                await _supabase.from('reviews').update({ photo_urls: '[]' }).lt('created_at', thirtyDaysAgo).eq('is_public', false);

                showNiceModal({ title: "Authorized", message: "All aged private media references have been purged.", type: "success" });
                fetchAllMedia();
            } catch (err) {
                showNiceModal({ title: "Error", message: err.message, type: "danger" });
            }
        }

        async function fetchLogs() {
            const tbody = document.getElementById('logs-table-body');

            try {
                // Fetch recent logs
                const { data: logsData, error } = await _supabase
                    .from('activity_logs')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) throw error;

                let displayLogs = logsData || [];

                // Filter by search
                if (currentSearchTerm) {
                    displayLogs = displayLogs.filter(l =>
                        (l.description && l.description.toLowerCase().includes(currentSearchTerm)) ||
                        (l.action_type && l.action_type.toLowerCase().includes(currentSearchTerm)) ||
                        (l.admin_id && l.admin_id.toLowerCase().includes(currentSearchTerm))
                    );
                }

                if (!displayLogs.length) {
                    tbody.innerHTML = `<tr><td colspan="4" class="p-20 text-center"><div class="flex flex-col items-center gap-4 opacity-30"><i class="fa-solid fa-scroll text-4xl"></i><p class="font-black uppercase tracking-[0.3em] text-[10px]">No audit records found</p></div></td></tr>`;
                    return;
                }

                tbody.innerHTML = displayLogs.map(l => `
                    <tr class="hover:bg-slate-50/50 transition-colors border-b border-slate-50">
                        <td class="p-6">
                            <div class="text-[11px] font-bold text-slate-600 font-mono">
                                ${new Date(l.created_at).toLocaleString()}
                            </div>
                        </td>
                        <td class="p-6">
                            <div class="flex items-center gap-2">
                                <div class="w-6 h-6 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-[9px] font-black uppercase">
                                    ${l.admin_id ? l.admin_id.substring(0, 2) : 'SY'}
                                </div>
                                <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Admin</span>
                            </div>
                        </td>
                        <td class="p-6">
                            <span class="px-2 py-1 rounded-md text-[9px] font-black uppercase tracking-widest ${l.action_type.includes('DELETE') ? 'bg-rose-100 text-rose-600' :
                        l.action_type.includes('UPDATE') ? 'bg-blue-100 text-blue-600' :
                            'bg-slate-100 text-slate-600'
                    }">${l.action_type}</span>
                        </td>
                        <td class="p-6">
                            <p class="text-[11px] font-medium text-slate-700 leading-relaxed">${l.description}</p>
                        </td>
                    </tr>
                `).join('');

            } catch (err) {
                console.error('Logs error:', err);
                tbody.innerHTML = `<tr><td colspan="4" class="p-12 text-center text-rose-500 font-bold uppercase tracking-widest text-[10px]">Error loading logs: ${err.message}</td></tr>`;
            }
        }

        // --- Audit Logging System ---
        async function logActivity(actionType, description, entityId = null) {
            try {
                const { data: { session } } = await _supabase.auth.getSession();
                if (!session) return;

                const { error } = await _supabase.from('activity_logs').insert([{
                    admin_id: session.user.id,
                    action_type: actionType,
                    description: description,
                    entity_id: entityId
                }]);

                if (error) console.warn('Audit Log Error:', error.message);
            } catch (err) {
                console.warn('Audit Log System unavailable:', err);
            }
        }



        // --- Data Export System ---
        async function exportToCSV(type) {
            try {
                showNiceModal({ title: "preparing export...", message: "Retrieving dataset for download.", type: "info" });

                let data = [];
                let filename = `${type}_export_${new Date().toISOString().split('T')[0]}.csv`;

                if (type === 'clients') {
                    const { data: clients } = await _supabase.from('profiles').select('*');
                    if (!clients) throw new Error("No client data found.");

                    // Define headers
                    const headers = ['ID', 'Full Name', 'Email', 'Address', 'Role', 'Created At'];
                    const rows = clients.map(c => [c.id, c.full_name, c.email, c.address, c.role, c.created_at]);
                    data = [headers, ...rows];
                } else if (type === 'bookings') {
                    const { data: bookings } = await _supabase
                        .from('bookings')
                        .select('*, profiles(full_name, email)');

                    if (!bookings) throw new Error("No booking data found.");

                    const headers = ['ID', 'Client Name', 'Client Email', 'Service Type', 'Status', 'Preferred Date', 'Location', 'Notes', 'Created At'];
                    const rows = bookings.map(b => [
                        b.id,
                        b.profiles?.full_name || 'Unknown',
                        b.profiles?.email || 'Unknown',
                        b.service_type,
                        b.status,
                        b.preferred_date,
                        b.location,
                        `"${(b.notes || '').replace(/"/g, '""')}"`, // Handle quotes in CSV
                        b.created_at
                    ]);
                    data = [headers, ...rows];
                }

                // Convert to CSV string
                const csvContent = "data:text/csv;charset=utf-8," +
                    data.map(e => e.join(",")).join("\n");

                // Trigger Download
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Hide modal (or show success briefly)
                document.getElementById('ui-modal').classList.remove('active');

            } catch (err) {
                console.error("Export Error:", err);
                showNiceModal({ title: "Export Failed", message: err.message, type: "danger" });
            }
        }

        async function handleLogout() {
            const confirmed = await showNiceModal({
                title: "Confirm Sign Out",
                message: "Signing out will terminate your current secure session. You will be required to authenticate with your credentials to access the admin console again.",
                type: "warning",
                confirmText: "End Session",
                cancelText: "Stay Logged In"
            });
            if (!confirmed) return;
            await _supabase.auth.signOut();
            window.location.href = 'index.html';
        }

        // --- Premium Modal System ---
        function showNiceModal({ title, message, type = 'info', confirmText = 'OK', cancelText = null }) {
            return new Promise((resolve) => {
                const modal = document.getElementById('ui-modal');
                const titleEl = document.getElementById('ui-modal-title');
                const msgEl = document.getElementById('ui-modal-msg');
                const iconContainer = document.getElementById('modal-icon-container');
                const confirmBtn = document.getElementById('modal-confirm');
                const cancelBtn = document.getElementById('modal-cancel');

                // Reset
                modal.className = 'modal-overlay active ' + `modal-${type}`;
                titleEl.innerText = title;
                msgEl.innerText = message;
                confirmBtn.innerText = confirmText;

                // Icons
                const icons = {
                    success: '<i class="fa-solid fa-circle-check"></i>',
                    danger: '<i class="fa-solid fa-triangle-exclamation"></i>',
                    warning: '<i class="fa-solid fa-circle-exclamation"></i>',
                    info: '<i class="fa-solid fa-circle-info"></i>'
                };
                iconContainer.innerHTML = icons[type] || icons.info;

                // Confirm button styling based on type
                const btnClasses = {
                    success: 'btn-gradient-success',
                    danger: 'btn-gradient-danger',
                    warning: 'btn-gradient-warning',
                    info: 'btn-gradient-info'
                };
                confirmBtn.className = `modal-btn ${btnClasses[type] || btnClasses.info}`;

                if (cancelText) {
                    cancelBtn.innerText = cancelText;
                    cancelBtn.className = 'modal-btn bg-white border border-slate-200 text-slate-500 hover:bg-slate-50 hover:text-slate-800 transition-colors shadow-sm';
                    cancelBtn.classList.remove('hidden');
                } else {
                    cancelBtn.classList.add('hidden');
                }

                confirmBtn.onclick = () => { modal.classList.remove('active'); resolve(true); };
                cancelBtn.onclick = () => { modal.classList.remove('active'); resolve(false); };
            });
        }

        function openLightbox(src) {
            const modal = document.getElementById('lightbox-modal');
            const container = document.getElementById('lightbox-content');
            const isVideo = src.toLowerCase().match(/\.(mp4|mov|webm|ogg|m4v)$/) || src.includes('/video/upload/');

            container.innerHTML = isVideo
                ? `<video src="${src}" controls autoplay class="max-w-full max-h-full rounded-2xl shadow-2xl"></video>`
                : `<img src="${src}" class="max-w-full max-h-full object-contain rounded-2xl shadow-2xl transition-all">`;

            modal.classList.add('active');
        }

        function closeLightbox() {
            document.getElementById('lightbox-modal').classList.remove('active');
            document.getElementById('lightbox-content').innerHTML = ''; // Stop video
        }

        // --- IN-APP NOTIFICATION SYSTEM ---
        let notifications = [];

        function toggleNotifications() {
            document.getElementById('notification-dropdown').classList.toggle('active');
        }

        async function fetchNotifications() {
            try {
                const { data: { session } } = await _supabase.auth.getSession();
                if (!session) return;

                const { data, error } = await _supabase
                    .from('notifications')
                    .select('*')
                    .eq('user_id', session.user.id)
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) throw error;
                notifications = data || [];
                renderNotifications();
            } catch (err) {
                console.error('Fetch Notifications Error:', err);
            }
        }

        function renderNotifications() {
            const list = document.getElementById('notification-list');
            const badge = document.getElementById('notification-badge');
            const unreadCount = notifications.filter(n => !n.is_read).length;

            if (unreadCount > 0) {
                badge.innerText = unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }

            if (notifications.length === 0) {
                list.innerHTML = `
                    <div class="p-8 text-center text-slate-400">
                        <i class="fa-solid fa-bell-slash text-2xl mb-3 opacity-20"></i>
                        <p class="text-[9px] font-black uppercase tracking-widest">No New Alerts</p>
                    </div>`;
                return;
            }

            list.innerHTML = notifications.map(n => `
                <div class="notification-item ${n.is_read ? '' : 'unread'}" onclick="openNotificationDetails(${n.id})">
                    <div class="flex gap-3">
                        <div class="w-8 h-8 rounded-lg bg-slate-50 flex items-center justify-center text-slate-400 shrink-0">
                            <i class="fa-solid ${getNotificationIcon(n.type)} text-xs text-${getNotificationColor(n.type)}-500"></i>
                        </div>
                        <div class="flex-1 text-left">
                            <p class="text-[10px] font-black uppercase tracking-tight text-slate-900 mb-0.5">${n.title}</p>
                            <p class="text-[9px] font-medium text-slate-500 leading-tight mb-2 truncate">${n.message}</p>
                            <p class="text-[7px] font-black text-slate-300 uppercase tracking-widest">${new Date(n.created_at).toLocaleString()}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getNotificationIcon(type) {
            const icons = { info: 'fa-info-circle', success: 'fa-check-circle', warning: 'fa-exclamation-circle', danger: 'fa-times-circle' };
            return icons[type] || icons.info;
        }

        function getNotificationColor(type) {
            const colors = { info: 'blue', success: 'emerald', warning: 'amber', danger: 'rose' };
            return colors[type] || colors.info;
        }

        async function openNotificationDetails(id) {
            const n = notifications.find(notif => notif.id === id);
            if (!n) return;

            // Mark as read first
            await markAsRead(id);

            // Show detail card (Using the premium modal system)
            showNiceModal({
                title: n.title,
                message: n.message,
                type: n.type || 'info',
                confirmText: "Back to Dashboard"
            });

            // Close dropdown if open
            document.getElementById('notification-dropdown').classList.remove('active');
        }

        async function markAsRead(id) {
            try {
                const { error } = await _supabase
                    .from('notifications')
                    .update({ is_read: true })
                    .eq('id', id);
                if (error) throw error;
                fetchNotifications();
            } catch (err) {
                console.error('Mark as read error:', err);
            }
        }

        async function markAllAsRead() {
            try {
                const { data: { session } } = await _supabase.auth.getSession();
                const { error } = await _supabase
                    .from('notifications')
                    .update({ is_read: true })
                    .eq('user_id', session.user.id);
                if (error) throw error;
                fetchNotifications();
            } catch (err) {
                console.error('Mark all as read error:', err);
            }
        }

        // Modified Notification Dispatcher (In-App instead of Email)
        async function sendInAppNotification(userId, title, message, type = 'info') {
            try {
                const { error } = await _supabase.from('notifications').insert([{
                    user_id: userId,
                    title: title,
                    message: message,
                    type: type
                }]);
                if (error) throw error;
                console.log(' In-app notification dispatched to user:', userId);
            } catch (err) {
                console.error('Failed to send in-app notification:', err);
            }
        }

        // Initial Load
        async function init() {
            try {
                // checkSession and initSessionTimeout are already initialized
                switchTab('accounts');
                fetchNotifications();
                // Check for new notifications every minute
                setInterval(fetchNotifications, 60000);
            } catch (err) {
                console.error("Initialization Error:", err);
            }
        }
        init();
    </script>
</body>

</html>